<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gram-Labh Margdarshak (Prototype)</title>
    
    <!-- CSS STYLES (Inline for portability) -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .mobile-container { width: 100%; max-width: 400px; min-height: 800px; background-color: #ffffff; box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); border-radius: 25px; overflow: hidden; display: flex; flex-direction: column; }
        header { background-color: #007bff; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; font-weight: bold; border-top-left-radius: 25px; border-top-right-radius: 25px; }
        .back-btn { cursor: pointer; font-size: 1.5em; padding-right: 15px; }
        .user-profile { cursor: pointer; font-size: 1.2em; }
        .screen { padding: 20px; flex-grow: 1; overflow-y: auto; display: none; background-color: #ffffff; }
        .screen.active { display: block; }
        .welcome-text { color: #333; margin-top: 0; font-size: 1.4em; }
        .subtitle { color: #666; margin-bottom: 20px; font-size: 0.9em; }
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .card { background-color: #e6f0ff; border: 1px solid #007bff; border-radius: 12px; padding: 15px; cursor: pointer; transition: transform 0.2s; text-align: center; box-shadow: 0 4px 8px rgba(0, 123, 255, 0.1); }
        .card:hover { background-color: #cce0ff; transform: translateY(-2px); }
        .card h3 { margin-top: 0; margin-bottom: 5px; color: #007bff; font-size: 1.1em; }
        .card p { margin: 0; color: #555; font-size: 0.8em; }
        .card.special-card { background-color: #d8f5d8; border: 1px solid #28a745; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2); }
        .card.special-card h3 { color: #28a745; }
        .action-btn { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin-top: 15px; transition: background-color 0.2s; }
        .action-btn:hover { background-color: #218838; }
        .action-btn.view-detail-btn {
            display: inline-block; /* Treat the link like a small button */
            width: 100px;
            padding: 5px;
            font-size: 0.8em;
            margin-top: 5px;
            background-color: #007bff;
            text-decoration: none; /* Remove underline */
            color: white;
            border-radius: 6px;
            text-align: center;
        }

        .reco-item { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; }
        .reco-item.best { border-left: 5px solid #28a745; background-color: #d4edda; }
        .subsidy-box { margin-top: 10px; padding: 10px; background-color: #e6f0ff; border-radius: 4px; border-left: 5px solid; font-size: 0.9em; color: #333; font-weight: bold; line-height: 1.4; }
        .subsidy-box .scheme-name { font-weight: normal; color: #555; display: block; margin-top: 3px; }
        .profile-input input, .input-section input, .input-section select { width: 95%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; margin-bottom: 10px; display: block; }
        .input-section label { display: block; margin-bottom: 3px; font-weight: bold; color: #555; } /* Ensures labels are block and separate from input */
        .role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .role-card { background-color: #f7f7ff; border: 2px solid #007bff; padding: 25px; cursor: pointer; text-align: center; }
        .reco-item.best-price { border-left: 5px solid #ffc107; background-color: #fff8e6; }
        .price-range { font-size: 1.6em; color: #d89b00; font-weight: bold; margin: 5px 0; }
        .comparison-alert { padding: 12px; border-radius: 8px; font-weight: bold; font-size: 1em; line-height: 1.4; text-align: center; margin-bottom: 15px; }
        .comparison-alert.alert-ok { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .comparison-alert.alert-high { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .comparison-alert.alert-low { background-color: #ffeeb3; color: #856404; border: 1px solid #ffeeba; }
        .switch-btn { cursor: pointer; font-size: 1.5em; padding-left: 15px; }
        #quick-switch-modal { position: absolute; top: 60px; right: 15px; width: 220px; background: #ffffff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 1000; display: none; padding: 5px 0; }
        .modal-item { padding: 10px 15px; font-size: 0.9em; cursor: pointer; color: #333; transition: background-color 0.1s; }
        .modal-item:hover { background-color: #f0f0f0; }
        .modal-item.reset-btn { border-top: 1px solid #eee; color: #dc3545; }
        .lang-switch-btn { 
            background: none; 
            border: 1px solid white; 
            color: white; 
            padding: 5px 8px; 
            border-radius: 4px; 
            font-size: 0.7em; 
            font-weight: bold;
            margin-right: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <header id="app-header">
            <span class="back-btn" onclick="goBack()">‚Üê</span>
            <span class="title" id="header-title" data-key="app_title">‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§™‡•É‡§∑‡•ç‡§† (Home)</span>
            
            <!-- NEW LANGUAGE SWITCH BUTTON -->
            <div style="display: flex; align-items: center;">
                <button class="lang-switch-btn" id="lang-button" onclick="switchLanguage()"></button>
                <span class="user-profile switch-btn" onclick="toggleQuickSwitchModal()">üë§</span>
            </div>
        </header>

        <!-- NEW QUICK SWITCH MODAL (For testing roles) -->
        <div id="quick-switch-modal">
            <div class="modal-item" onclick="quickSwitchAccount('farmer')">üßë‚Äçüåæ <span data-key="switch_farmer">‡§∂‡•á‡§§‡§ï‡§∞‡•Ä (Farmer)</span></div>
            <div class="modal-item" onclick="quickSwitchAccount('trader')">üöö <span data-key="switch_trader">‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡•Ä (Trader)</span></div>
            <div class="modal-item reset-btn" onclick="localStorage.clear(); checkUserStatus();"><span data-key="switch_reset">‡§®‡§µ‡•Ä‡§® ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§ï‡§∞‡§æ</span></div>
        </div>

        <!-- ========================================================== -->
        <!-- 1. ONBOARDING / AUTHENTICATION SCREENS -->
        <!-- ========================================================== -->
        <div class="screen active" id="loading">
            <h2 class="welcome-text text-center text-blue-600" data-key="loading_title">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</h2>
            <p class="subtitle text-center" data-key="loading_subtitle">‡§∏‡•ç‡§•‡§æ‡§®‡§ø‡§ï ‡§°‡•á‡§ü‡§æ ‡§§‡§™‡§æ‡§∏‡§§ ‡§Ü‡§π‡•á...</p>
        </div>
        <div class="screen" id="onboarding">
            <h2 class="welcome-text" style="color:#007bff;" data-key="welcome_title">üëã ‡§ó‡•ç‡§∞‡§æ‡§Æ-‡§≤‡§æ‡§≠ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Ü‡§™‡§≤‡•á ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§!</h2>
            <p class="subtitle" data-key="register_subtitle">‡§∏‡•á‡§µ‡§æ ‡§µ‡§æ‡§™‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§ï‡§∞‡§æ‡•§</p>
            <form id="reg-form">
                <div class="input-section">
                    <label for="reg-name" data-key="label_name">‡§®‡§æ‡§µ (Full Name):</label>
                    <input type="text" id="reg-name" required placeholder="‡§â‡§¶‡§æ. ‡§ú‡§Ø ‡§ú‡§Ø‡§∏‡•ç‡§µ‡§æ‡§≤" class="rounded p-2 border">
                </div>
                <div class="input-section">
                    <label for="reg-phone" data-key="label_phone">‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ (Phone):</label>
                    <input type="tel" id="reg-phone" required placeholder="10 ‡§Ö‡§Ç‡§ï‡•Ä ‡§®‡§Ç‡§¨‡§∞" class="rounded p-2 border">
                </div>
                <div class="input-section">
                    <label for="reg-taluka" data-key="label_taluka">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ (Taluka):</label>
                    <input type="text" id="reg-taluka" required placeholder="‡§â‡§¶‡§æ. ‡§∂‡§ø‡§∞‡•Ç‡§∞" class="rounded p-2 border">
                </div>
                <button type="submit" class="action-btn" data-key="btn_next">‡§™‡•Å‡§¢‡•Ä‡§≤ ‡§ö‡§∞‡§£ (Next Step) ‚Üí</button>
            </form>
        </div>

        <div class="screen" id="role-select">
            <h2 class="welcome-text" style="color:#007bff;" data-key="role_select_title">‡§Ü‡§™‡§≤‡•Ä ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ</h2>
            <p class="subtitle" data-key="role_select_subtitle">‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§§‡§É ‡§ï‡§æ‡§Ø ‡§Ü‡§π‡§æ‡§§?</p>
            <div class="card-grid role-grid">
                <div class="card role-card" onclick="selectRole('Farmer/Seller')">
                    <h3>üßë‚Äçüåæ <span data-key="role_farmer_h">‡§∂‡•á‡§§‡§ï‡§∞‡•Ä / ‡§µ‡§ø‡§ï‡•ç‡§∞‡•á‡§§‡§æ</span></h3>
                    <p data-key="role_farmer_p">‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®, ‡§ï‡§ø‡§Ç‡§Æ‡§§ ‡§Ü‡§£‡§ø ‡§Ö‡§®‡•Å‡§¶‡§æ‡§® ‡§∏‡§≤‡•ç‡§≤‡§æ ‡§π‡§µ‡§æ‡•§</p>
                </div>
                <div class="card role-card" onclick="selectRole('Trader')">
                    <h3>üöö <span data-key="role_trader_h">‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡•Ä / ‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞</span></h3>
                    <p data-key="role_trader_p">‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§¶‡§∞, ‡§Æ‡§æ‡§ó‡§£‡•Ä ‡§Ü‡§£‡§ø ‡§≤‡•â‡§ú‡§ø‡§∏‡•ç‡§ü‡§ø‡§ï‡•ç‡§∏ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§π‡§µ‡•Ä‡•§</p>
                </div>
            </div>
        </div>

        <!-- ========================================================== -->
        <!-- 2. ROLE-SPECIFIC DASHBOARDS -->
        <!-- ========================================================== -->

        <!-- FARMER DASHBOARD -->
        <div class="screen" id="farmer-dashboard">
            <h2 class="welcome-text" id="farmer-welcome">üëã ‡§®‡§Æ‡§∏‡•ç‡§§‡•á!</h2>
            <p class="subtitle" id="farmer-info-display"></p>
            <div class="card-grid role-feature-grid">
                <div class="card" onclick="showScreen('production')"><h3>üå± <span data-key="dash_planner_h">‡§®‡§ø‡§Ø‡•ã‡§ú‡§ï</span></h3><p data-key="dash_planner_p">‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§∏‡§≤‡•ç‡§≤‡§æ</p></div>
                <div class="card special-card" onclick="showScreen('subsidy-info-page')"><h3>üí∞ <span data-key="dash_subsidy_h">‡§Ö‡§®‡•Å‡§¶‡§æ‡§®</span></h3><p data-key="dash_subsidy_p">‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡§™‡§æ‡§∏‡§æ</p></div>
                <div class="card" onclick="showScreen('pricing')"><h3>üìà <span data-key="dash_price_h">‡§¶‡§∞ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£</span></h3><p data-key="dash_price_p">‡§ï‡§ø‡§Ç‡§Æ‡§§ ‡§†‡§∞‡§µ‡§æ</p></div>
                <div class="card" onclick="showScreen('list-product-form')"><h3>‚ûï <span data-key="dash_add_p_h">‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ú‡•ã‡§°‡§æ</span></h3><p data-key="dash_add_p_p">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡§∞‡§æ</p></div>
                <div class="card" onclick="showScreen('trader-requests-for-farmer')"><h3>üì¶ <span data-key="dash_buyer_req_h">‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞ ‡§µ‡§ø‡§®‡§Ç‡§§‡•ç‡§Ø‡§æ</span></h3><p data-key="dash_buyer_req_p">‡§Æ‡§æ‡§ó‡§£‡•Ä ‡§™‡§π‡§æ</p></div>
            </div>
            <div class="demand-radar mt-6 bg-yellow-100 p-4 rounded-xl border-l-4 border-yellow-500">
                <h3 class="text-yellow-900 font-bold mb-2" data-key="dash_my_listing">‚ö° ‡§Æ‡§æ‡§ù‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó (My Products)</h3>
                <div class="reco-list" id="my-farm-listings"></div>
            </div>
        </div>

        <!-- TRADER DASHBOARD -->
        <div class="screen" id="trader-dashboard">
            <h2 class="welcome-text" id="trader-welcome">üëã ‡§®‡§Æ‡§∏‡•ç‡§§‡•á!</h2>
            <p class="subtitle" id="trader-info-display"></p>
            <div class="card-grid role-feature-grid">
                <div class="card" onclick="showScreen('list-shop-form')"><h3>üìù <span data-key="dash_add_req_h">‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ</span></h3><p data-key="dash_add_req_p">‡§Æ‡§æ‡§≤ ‡§ñ‡§∞‡•á‡§¶‡•Ä‡§ö‡•Ä ‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä</p></div>
                <div class="card special-card" onclick="showScreen('competition')"><h3>üõí <span data-key="dash_market_h">‡§∏‡•ç‡§•‡§æ‡§®‡§ø‡§ï ‡§¨‡§æ‡§ú‡§æ‡§∞‡§™‡•á‡§†</span></h3><p data-key="dash_market_p">‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡•á</p></div>
                <div class="card" onclick="showScreen('pricing')"><h3>üìà <span data-key="dash_price_h">‡§¶‡§∞ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£</span></h3><p data-key="dash_price_t_p">‡§ñ‡§∞‡•á‡§¶‡•Ä‡§ö‡•Ä ‡§ï‡§ø‡§Ç‡§Æ‡§§ ‡§†‡§∞‡§µ‡§æ</p></div>
            </div>
            <div class="demand-radar mt-6 bg-blue-100 p-4 rounded-xl border-l-4 border-blue-500">
                <h3 class="text-blue-900 font-bold mb-2" data-key="dash_my_req">üì¢ ‡§Æ‡§æ‡§ù‡•ç‡§Ø‡§æ ‡§µ‡§ø‡§®‡§Ç‡§§‡•ç‡§Ø‡§æ (My Requests)</h3>
                <div class="reco-list" id="my-trader-requests"></div>
            </div>
        </div>
        
        <!-- ========================================================== -->
        <!-- 3. FEATURE SCREENS -->
        <!-- ========================================================== -->

        <!-- USER PROFILE SCREEN -->
        <div class="screen" id="user-profile">
            <h2 class="text-blue-600" data-key="profile_title">‡§Æ‡§æ‡§ù‡§æ ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ (My Profile)</h2>
            <form id="profile-edit-form">
                <div class="profile-input">
                    <label data-key="label_name_p">‡§®‡§æ‡§µ:</label>
                    <input type="text" id="profile-name" readonly>
                </div>
                <div class="profile-input">
                    <label data-key="label_phone_p">‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞:</label>
                    <input type="tel" id="profile-phone" readonly>
                </div>
                <div class="profile-input">
                    <label data-key="label_taluka_p">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ:</label>
                    <input type="text" id="profile-taluka" readonly>
                </div>
                <div class="profile-input">
                    <label data-key="label_role_p">‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ:</label>
                    <input type="text" id="profile-role" readonly>
                </div>
                <button type="button" class="action-btn" onclick="goBack()" data-key="btn_back">‡§Æ‡§æ‡§ó‡•á ‡§ú‡§æ</button>
            </form>
        </div>

        <!-- FARMER: TRADER REQUESTS SCREEN -->
        <div class="screen" id="trader-requests-for-farmer">
            <h2 class="text-blue-600" data-key="buyer_req_title">‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞ ‡§µ‡§ø‡§®‡§Ç‡§§‡•ç‡§Ø‡§æ (Buyer Requests)</h2>
            <p class="subtitle" data-key="buyer_req_subtitle">‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§≤‡§æ‡§ö‡•Ä ‡§Æ‡§æ‡§ó‡§£‡•Ä ‡§ï‡§∞‡§£‡§æ‡§∞‡•á ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡•Ä‡•§</p>
            <div class="reco-list" id="trader-request-listings"></div>
        </div>

        <!-- TRADER: MARKETPLACE SCREEN -->
        <div class="screen" id="competition">
            <h2 class="text-blue-600" data-key="market_title">üõí ‡§∏‡•ç‡§•‡§æ‡§®‡§ø‡§ï ‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§¨‡§æ‡§ú‡§æ‡§∞‡§™‡•á‡§†</h2>
            <p class="subtitle" data-key="market_subtitle">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Ö‡§∏‡§≤‡•á‡§≤‡•Ä ‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡•á‡•§</p>
            <div class="reco-list" id="farmer-market-listings"></div>
        </div>
        
        <!-- SUBSIDY INFO PAGE -->
        <div class="screen" id="subsidy-info-page">
            <h2 class="text-green-600" data-key="subsidy_portal_title">‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤</h2>
            <p class="subtitle" data-key="subsidy_portal_subtitle">‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡•á‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ú‡•Å‡§≥‡§£‡§æ‡§±‡•ç‡§Ø‡§æ ‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§Ø‡•ã‡§ú‡§®‡§æ‡•§</p>
            <div class="reco-list" id="general-subsidy-list"></div>
        </div>

        <!-- FARMER: LIST PRODUCT FORM -->
        <div class="screen" id="list-product-form">
            <h2 class="text-blue-600" data-key="list_product_form_title">‡§®‡§µ‡•Ä‡§® ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ú‡•ã‡§°‡§æ</h2>
            <p class="subtitle" data-key="list_product_form_subtitle">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Æ‡§æ‡§≤ ‡§Ü‡§£‡§ø ‡§ï‡§ø‡§Ç‡§Æ‡§§ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü ‡§ï‡§∞‡§æ‡•§</p>
            <form id="product-listing-form">
                <div class="input-section">
                    <label for="list-product" data-key="list_p_name_l">‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§ö‡•á ‡§®‡§æ‡§µ:</label>
                    <input type="text" id="list-product" required placeholder="‡§â‡§¶‡§æ. ‡§π‡§≥‡§¶ ‡§™‡§æ‡§µ‡§°‡§∞">
                </div>
                <div class="input-section">
                    <label for="list-qty" data-key="list_p_qty_l">‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (Kg/Quintal):</label>
                    <input type="number" id="list-qty" required placeholder="‡§â‡§¶‡§æ. 500">
                </div>
                <div class="input-section">
                    <label for="list-price" data-key="list_p_price_l">‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§¶‡§∞ (‚Çπ ‡§™‡•ç‡§∞‡§§‡§ø ‡§Ø‡•Å‡§®‡§ø‡§ü):</label>
                    <input type="number" id="list-price" required placeholder="‡§â‡§¶‡§æ. 75">
                </div>
                <button type="submit" class="action-btn" data-key="btn_list_market">‡§¨‡§æ‡§ú‡§æ‡§∞‡§™‡•á‡§†‡•á‡§§ ‡§∏‡•Ç‡§ö‡•Ä‡§¨‡§¶‡•ç‡§ß ‡§ï‡§∞‡§æ</button>
            </form>
        </div>

        <!-- TRADER: LIST SHOP REQUEST FORM -->
        <div class="screen" id="list-shop-form">
            <h2 class="text-blue-600" data-key="list_req_form_title">‡§ñ‡§∞‡•á‡§¶‡•Ä ‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ</h2>
            <p class="subtitle" data-key="list_req_form_subtitle">‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§ï‡§æ‡§Ø ‡§∂‡•ã‡§ß‡§§ ‡§Ü‡§π‡§æ‡§§ ‡§Ü‡§£‡§ø ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§¶‡•Å‡§ï‡§æ‡§®‡§æ‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§¶‡•ç‡§Ø‡§æ‡•§</p>
            <form id="shop-listing-form">
                <div class="input-section">
                    <label for="list-shop-name" data-key="list_s_name_l">‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§¶‡•Å‡§ï‡§æ‡§®‡§æ‡§ö‡•á/‡§∏‡§Ç‡§∏‡•ç‡§•‡•á‡§ö‡•á ‡§®‡§æ‡§µ:</label>
                    <input type="text" id="list-shop-name" required placeholder="‡§â‡§¶‡§æ. ‡§∂‡•ç‡§∞‡•Ä‡§∞‡§æ‡§Æ ‡§ü‡•ç‡§∞‡•á‡§°‡§∞‡•ç‡§∏">
                </div>
                <div class="input-section">
                    <label for="list-needs" data-key="list_s_needs_l">‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§≤‡§æ ‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§≤‡§æ‡§ö‡•Ä ‡§ó‡§∞‡§ú ‡§Ü‡§π‡•á?</label>
                    <input type="text" id="list-needs" required placeholder="‡§â‡§¶‡§æ. 1000 ‡§ï‡§ø‡§≤‡•ã ‡§ï‡§æ‡§Ç‡§¶‡§æ">
                </div>
                <button type="submit" class="action-btn" data-key="btn_publish_req">‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ø‡§§ ‡§ï‡§∞‡§æ</button>
            </form>
        </div>
        
        <!-- Production and Pricing screens -->
        <div class="screen" id="production">
            <h2 class="text-blue-600" data-key="prod_planner_title">‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§®‡§ø‡§Ø‡•ã‡§ú‡§ï (Production Planner)</h2>
            <p class="subtitle" data-key="prod_planner_subtitle">‡§§‡•Å‡§Æ‡§ö‡§æ ‡§ú‡§Æ‡§ø‡§®‡•Ä‡§ö‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§Ü‡§£‡§ø ‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§™‡§æ‡§ä‡§∏ ‡§®‡§ø‡§µ‡§°‡§æ:</p>

            <div class="input-section">
                <label for="soil-type" data-key="label_soil">‡§ú‡§Æ‡§ø‡§®‡•Ä‡§ö‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ (Soil Type):</label>
                <select id="soil-type">
                    <option value="Black">‡§ï‡§æ‡§≥‡•Ä ‡§Æ‡§æ‡§§‡•Ä (Black Soil)</option>
                    <option value="Red">‡§≤‡§æ‡§≤ ‡§Æ‡§æ‡§§‡•Ä (Red Soil)</option>
                    <option value="Alluvial">‡§ó‡§æ‡§≥‡§æ‡§ö‡•Ä ‡§Æ‡§æ‡§§‡•Ä (Alluvial Soil)</option>
                </select>
            </div>
            <div class="input-section">
                <label for="rainfall" data-key="label_rain">‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§™‡§æ‡§ä‡§∏ (Expected Rainfall):</label>
                <select id="rainfall">
                    <option value="High">‡§ú‡§æ‡§∏‡•ç‡§§ (High)</option>
                    <option value="Medium">‡§Æ‡§ß‡•ç‡§Ø‡§Æ (Medium)</option>
                    <option value="Low">‡§ï‡§Æ‡•Ä (Low)</option>
                </select>
            </div>

            <button class="action-btn" onclick="runKNN()" data-key="btn_get_reco">‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§Æ‡§ø‡§≥‡§µ‡§æ (Get Recommendation)</button>

            <div class="reco-list" id="production-recommendations">
                <p style="text-align: center; color: #666;" data-key="prod_initial_text">‡§µ‡§∞‡§ö‡•á ‡§¨‡§ü‡§£ ‡§¶‡§æ‡§¨‡•Ç‡§® ‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§Æ‡§ø‡§≥‡§µ‡§æ‡•§</p>
            </div>
        </div>

        <div class="screen" id="pricing">
            <h2 class="text-blue-600" data-key="price_title">üìà ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Ü‡§£‡§ø ‡§¶‡§∞ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£</h2>
            <p class="subtitle" data-key="price_subtitle">‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§ö‡§æ ‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§¶‡§∞ ‡§Ü‡§£‡§ø ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü ‡§ï‡§∞‡§æ‡•§</p>

            <div class="input-section">
                <label for="product-select" data-key="list_p_name_l_p">‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§ö‡•á ‡§®‡§æ‡§µ (Product Name):</label>
                <select id="product-select" required>
                    <option value="" data-key="price_select_p">-- ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§®‡§ø‡§µ‡§°‡§æ --</option>
                    <option value="Tomato">‡§ü‡•â‡§Æ‡•á‡§ü‡•ã (Tomato)</option>
                    <option value="Onion">‡§ï‡§æ‡§Ç‡§¶‡§æ (Onion)</option>
                    <option value="Turmeric">‡§π‡§≥‡§¶ (Turmeric)</option>
                    <option value="Sugarcane">‡§ä‡§∏ (Sugarcane)</option>
                </select>
            </div>
            
            <div class="input-section">
                <label for="quantity" data-key="list_p_qty_l_p">‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (Quantity - Kg/L):</label>
                <input type="number" id="quantity" value="100" required placeholder="‡§â‡§¶‡§æ‡•§ 100">
            </div>

            <div class="input-section">
                <label for="cost" data-key="price_cost_l">‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ñ‡§∞‡•ç‡§ö (Cost/Kg - ‚Çπ):</label>
                <input type="number" id="cost" value="15" required placeholder="‡§â‡§¶‡§æ‡•§ 15">
            </div>

            <div class="input-section">
                <label for="user-price-input" data-key="price_your_price_l">‡§§‡•Å‡§Æ‡§ö‡§æ ‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§¶‡§∞ (Your Price - ‚Çπ/Kg):</label>
                <input type="number" id="user-price-input" value="35" required placeholder="‡§â‡§¶‡§æ‡•§ 35">
            </div>

            <button class="action-btn" onclick="runPricingAdvisor()" data-key="btn_analyze_price">‡§¶‡§∞ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§æ (Analyze Price & List)</button> 

            <div id="price-result-message" style="display:none; margin-top: 20px;">
                <div id="price-comparison-alert" class="comparison-alert"></div>
            </div>

            <div class="reco-list">
                <div class="reco-item best-price">
                    <h4 data-key="price_reco_h">‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§ï‡•á‡§≤‡•á‡§≤‡§æ ‡§¶‡§∞ (Recommended Price Range)</h4>
                    <p class="price-range" data-key="price_reco_init">**‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§¨‡§ü‡§£ ‡§¶‡§æ‡§¨‡§æ**</p>
                    <p class="small-text" data-key="price_reco_p">‡§¨‡§æ‡§ú‡§æ‡§∞‡§æ‡§§‡•Ä‡§≤ ‡§Æ‡§æ‡§ó‡§£‡•Ä ‡§Ü‡§£‡§ø ‡§ñ‡§∞‡•ç‡§ö‡§æ‡§µ‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§‡•§</p>
                </div>
            </div>
            
            <p class="current-market-data">
                <span data-key="price_current_p1">**‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®:** -- </span><br>
                <span data-key="price_current-p2">**‡§≤‡§æ‡§á‡§µ‡•ç‡§π APMC ‡§¶‡§∞:** -- </span><br>
                <span data-key="price_current-p3">**‡§Ü‡§™‡§≤‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ñ‡§∞‡•ç‡§ö:** -- </span>
            </p>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // =================================================================
        // 1. LANGUAGE DATA & STATE
        // =================================================================

        let currentLang = localStorage.getItem('appLang') || 'mr';

        const LANGUAGES = {
            'mr': {
                'app_title': '‡§ó‡•ç‡§∞‡§æ‡§Æ-‡§≤‡§æ‡§≠ ‡§Æ‡§æ‡§∞‡•ç‡§ó‡§¶‡§∞‡•ç‡§∂‡§ï',
                'loading_title': '‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...',
                'loading_subtitle': '‡§∏‡•ç‡§•‡§æ‡§®‡§ø‡§ï ‡§°‡•á‡§ü‡§æ ‡§§‡§™‡§æ‡§∏‡§§ ‡§Ü‡§π‡•á...',
                'welcome_title': 'üëã ‡§ó‡•ç‡§∞‡§æ‡§Æ-‡§≤‡§æ‡§≠ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Ü‡§™‡§≤‡•á ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§!',
                'register_subtitle': '‡§∏‡•á‡§µ‡§æ ‡§µ‡§æ‡§™‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§ï‡§∞‡§æ‡•§',
                'label_name': '‡§®‡§æ‡§µ (Full Name):', 'label_phone': '‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ (Phone):', 'label_taluka': '‡§§‡§æ‡§≤‡•Å‡§ï‡§æ (Taluka):',
                'btn_next': '‡§™‡•Å‡§¢‡•Ä‡§≤ ‡§ö‡§∞‡§£ ‚Üí',
                'role_select_title': '‡§Ü‡§™‡§≤‡•Ä ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ', 'role_select_subtitle': '‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§§‡§É ‡§ï‡§æ‡§Ø ‡§Ü‡§π‡§æ‡§§?',
                'role_farmer_h': '‡§∂‡•á‡§§‡§ï‡§∞‡•Ä / ‡§µ‡§ø‡§ï‡•ç‡§∞‡•á‡§§‡§æ', 'role_farmer_p': '‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®, ‡§ï‡§ø‡§Ç‡§Æ‡§§ ‡§Ü‡§£‡§ø ‡§Ö‡§®‡•Å‡§¶‡§æ‡§® ‡§∏‡§≤‡•ç‡§≤‡§æ ‡§π‡§µ‡§æ‡•§',
                'role_trader_h': '‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡•Ä / ‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞', 'role_trader_p': '‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§¶‡§∞, ‡§Æ‡§æ‡§ó‡§£‡•Ä ‡§Ü‡§£‡§ø ‡§≤‡•â‡§ú‡§ø‡§∏‡•ç‡§ü‡§ø‡§ï‡•ç‡§∏ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§π‡§µ‡•Ä‡•§',
                'dash_planner_h': '‡§®‡§ø‡§Ø‡•ã‡§ú‡§ï', 'dash_planner_p': '‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§∏‡§≤‡•ç‡§≤‡§æ',
                'dash_subsidy_h': '‡§Ö‡§®‡•Å‡§¶‡§æ‡§®', 'dash_subsidy_p': '‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡§™‡§æ‡§∏‡§æ',
                'dash_price_h': '‡§¶‡§∞ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£', 'dash_price_p': '‡§ï‡§ø‡§Ç‡§Æ‡§§ ‡§†‡§∞‡§µ‡§æ', 'dash_price_t_p': '‡§ñ‡§∞‡•á‡§¶‡•Ä‡§ö‡•Ä ‡§ï‡§ø‡§Ç‡§Æ‡§§ ‡§†‡§∞‡§µ‡§æ',
                'dash_add_p_h': '‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ú‡•ã‡§°‡§æ', 'dash_add_p_p': '‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡§∞‡§æ',
                'dash_buyer_req_h': '‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞ ‡§µ‡§ø‡§®‡§Ç‡§§‡•ç‡§Ø‡§æ', 'dash_buyer_req_p': '‡§Æ‡§æ‡§ó‡§£‡•Ä ‡§™‡§π‡§æ',
                'dash_add_req_h': '‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ', 'dash_add_req_p': '‡§Æ‡§æ‡§≤ ‡§ñ‡§∞‡•á‡§¶‡•Ä‡§ö‡•Ä ‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä',
                'dash_market_h': '‡§∏‡•ç‡§•‡§æ‡§®‡§ø‡§ï ‡§¨‡§æ‡§ú‡§æ‡§∞‡§™‡•á‡§†', 'dash_market_p': '‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡•á',
                'dash_my_listing': '‚ö° ‡§Æ‡§æ‡§ù‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó (My Products)',
                'dash_my_req': 'üì¢ ‡§Æ‡§æ‡§ù‡•ç‡§Ø‡§æ ‡§µ‡§ø‡§®‡§Ç‡§§‡•ç‡§Ø‡§æ (My Requests)',
                'switch_farmer': '‡§∂‡•á‡§§‡§ï‡§∞‡•Ä (Farmer)', 'switch_trader': '‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡•Ä (Trader)', 'switch_reset': 'üö´ ‡§®‡§µ‡•Ä‡§® ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§ï‡§∞‡§æ',
                'profile_title': '‡§Æ‡§æ‡§ù‡§æ ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ (My Profile)',
                'label_name_p': '‡§®‡§æ‡§µ:', 'label_phone_p': '‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞:', 'label_taluka_p': '‡§§‡§æ‡§≤‡•Å‡§ï‡§æ:', 'label_role_p': '‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ:',
                'btn_back': '‡§Æ‡§æ‡§ó‡•á ‡§ú‡§æ',
                'buyer_req_title': '‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞ ‡§µ‡§ø‡§®‡§Ç‡§§‡•ç‡§Ø‡§æ (Buyer Requests)', 'buyer_req_subtitle': '‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§≤‡§æ‡§ö‡•Ä ‡§Æ‡§æ‡§ó‡§£‡•Ä ‡§ï‡§∞‡§£‡§æ‡§∞‡•á ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡•Ä‡•§',
                'market_title': 'üõí ‡§∏‡•ç‡§•‡§æ‡§®‡§ø‡§ï ‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§¨‡§æ‡§ú‡§æ‡§∞‡§™‡•á‡§†', 'market_subtitle': '‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Ö‡§∏‡§≤‡•á‡§≤‡•Ä ‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡•á‡•§',
                'subsidy_portal_title': '‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤', 'subsidy_portal_subtitle': '‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡•á‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ú‡•Å‡§≥‡§£‡§æ‡§±‡•ç‡§Ø‡§æ ‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§Ø‡•ã‡§ú‡§®‡§æ‡•§',
                'list_product_form_title': '‡§®‡§µ‡•Ä‡§® ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ú‡•ã‡§°‡§æ', 'list_product_form_subtitle': '‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Æ‡§æ‡§≤ ‡§Ü‡§£‡§ø ‡§ï‡§ø‡§Ç‡§Æ‡§§ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü ‡§ï‡§∞‡§æ‡•§',
                'list_p_name_l': '‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§ö‡•á ‡§®‡§æ‡§µ:', 'list_p_qty_l': '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (Kg/Quintal):', 'list_p_price_l': '‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§¶‡§∞ (‚Çπ ‡§™‡•ç‡§∞‡§§‡§ø ‡§Ø‡•Å‡§®‡§ø‡§ü):',
                'btn_list_market': '‡§¨‡§æ‡§ú‡§æ‡§∞‡§™‡•á‡§†‡•á‡§§ ‡§∏‡•Ç‡§ö‡•Ä‡§¨‡§¶‡•ç‡§ß ‡§ï‡§∞‡§æ',
                'list_req_form_title': '‡§ñ‡§∞‡•á‡§¶‡•Ä ‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ', 'list_req_form_subtitle': '‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§ï‡§æ‡§Ø ‡§∂‡•ã‡§ß‡§§ ‡§Ü‡§π‡§æ‡§§ ‡§Ü‡§£‡§ø ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§¶‡•Å‡§ï‡§æ‡§®‡§æ‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§¶‡•ç‡§Ø‡§æ‡•§',
                'list_s_name_l': '‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§¶‡•Å‡§ï‡§æ‡§®‡§æ‡§ö‡•á/‡§∏‡§Ç‡§∏‡•ç‡§•‡•á‡§ö‡•á ‡§®‡§æ‡§µ:', 'list_s_needs_l': '‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§≤‡§æ ‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§≤‡§æ‡§ö‡•Ä ‡§ó‡§∞‡§ú ‡§Ü‡§π‡•á?',
                'btn_publish_req': '‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ø‡§§ ‡§ï‡§∞‡§æ',
                'prod_planner_title': '‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§®‡§ø‡§Ø‡•ã‡§ú‡§ï (Production Planner)', 'prod_planner_subtitle': '‡§§‡•Å‡§Æ‡§ö‡§æ ‡§ú‡§Æ‡§ø‡§®‡•Ä‡§ö‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§Ü‡§£‡§ø ‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§™‡§æ‡§ä‡§∏ ‡§®‡§ø‡§µ‡§°‡§æ:',
                'label_soil': '‡§ú‡§Æ‡§ø‡§®‡•Ä‡§ö‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ (Soil Type):', 'label_rain': '‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§™‡§æ‡§ä‡§∏ (Expected Rainfall):',
                'btn_get_reco': '‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§Æ‡§ø‡§≥‡§µ‡§æ (Get Recommendation)', 'prod_initial_text': '‡§µ‡§∞‡§ö‡•á ‡§¨‡§ü‡§£ ‡§¶‡§æ‡§¨‡•Ç‡§® ‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§Æ‡§ø‡§≥‡§µ‡§æ‡•§',
                'price_title': 'üìà ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Ü‡§£‡§ø ‡§¶‡§∞ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£', 'price_subtitle': '‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§ö‡§æ ‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§¶‡§∞ ‡§Ü‡§£‡§ø ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü ‡§ï‡§∞‡§æ‡•§',
                'list_p_name_l_p': '‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®‡§æ‡§ö‡•á ‡§®‡§æ‡§µ (Product Name):', 'list_p_qty_l_p': '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (Quantity - Kg/L):', 'price_cost_l': '‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ñ‡§∞‡•ç‡§ö (Cost/Kg - ‚Çπ):',
                'price_your_price_l': '‡§§‡•Å‡§Æ‡§ö‡§æ ‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§¶‡§∞ (Your Price - ‚Çπ/Kg):', 'btn_analyze_price': '‡§¶‡§∞ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§æ (Analyze Price & List)',
                'price_select_p': '-- ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§®‡§ø‡§µ‡§°‡§æ --', 'price_reco_h': '‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§ï‡•á‡§≤‡•á‡§≤‡§æ ‡§¶‡§∞ (Recommended Price Range)',
                'price_reco_init': '**‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§¨‡§ü‡§£ ‡§¶‡§æ‡§¨‡§æ**', 'price_reco_p': '‡§¨‡§æ‡§ú‡§æ‡§∞‡§æ‡§§‡•Ä‡§≤ ‡§Æ‡§æ‡§ó‡§£‡•Ä ‡§Ü‡§£‡§ø ‡§ñ‡§∞‡•ç‡§ö‡§æ‡§µ‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§‡•§',
                'price_current_p1': '**‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®:** --', 'price_current_p2': '**‡§≤‡§æ‡§á‡§µ‡•ç‡§π APMC ‡§¶‡§∞:** --', 'price_current_p3': '**‡§Ü‡§™‡§≤‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ñ‡§∞‡•ç‡§ö:** --',
                'knn_profit': '‡§™‡•ç‡§∞‡•â‡§´‡§ø‡§ü ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§® (Est. Profit):', 'knn_water': '‡§™‡§æ‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§ó‡§∞‡§ú (Water Need):', 'knn_match': '‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§ú‡•Å‡§≥‡§≤‡•Ä!',
                'market_unit': '‚Çπ ‡§™‡•ç‡§∞‡§§‡§ø ‡§Ø‡•Å‡§®‡§ø‡§ü', 'market_seller': '‡§µ‡§ø‡§ï‡•ç‡§∞‡•á‡§§‡§æ', 'market_qty': 'Kg', 'req_contact': 'üìû ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï',
                'req_needs': '‡§ó‡§∞‡§ú:', 'req_trader': '‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡•Ä:', 'req_shop': '‡§¶‡•Å‡§ï‡§æ‡§®:',
                'dash_my_products': '‡§Æ‡§æ‡§ù‡•á ‡§∏‡•Ç‡§ö‡•Ä‡§¨‡§¶‡•ç‡§ß ‡§Æ‡§æ‡§≤', 'dash_my_requests': '‡§Æ‡§æ‡§ù‡•ç‡§Ø‡§æ ‡§∏‡•ç‡§•‡§æ‡§®‡§ø‡§ï ‡§µ‡§ø‡§®‡§Ç‡§§‡•ç‡§Ø‡§æ',
                'default_taluka_name': '‡§∂‡§ø‡§∞‡•Ç‡§∞',
                'home_welcome': 'üëã ‡§®‡§Æ‡§∏‡•ç‡§§‡•á,',
                'home_welcome_role': '‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ'
            },
            'en': {
                'app_title': 'Gram-Labh Navigator',
                'loading_title': 'Loading...',
                'loading_subtitle': 'Checking Local Data...',
                'welcome_title': 'üëã Welcome to Gram-Labh!',
                'register_subtitle': 'Please register to use the service.',
                'label_name': 'Full Name:', 'label_phone': 'Phone Number:', 'label_taluka': 'Taluka:',
                'btn_next': 'Next Step ‚Üí',
                'role_select_title': 'Select Your Role', 'role_select_subtitle': 'What is your primary role?',
                'role_farmer_h': 'Farmer / Seller', 'role_farmer_p': 'Needs advice on production, pricing, and subsidies.',
                'role_trader_h': 'Trader / Buyer', 'role_trader_p': 'Needs market rates, demand, and logistics info.',
                'dash_planner_h': 'Planner', 'dash_planner_p': 'Production Advice',
                'dash_subsidy_h': 'Grants', 'dash_subsidy_p': 'Check Schemes',
                'dash_price_h': 'Price Analysis', 'dash_price_p': 'Set Sale Price', 'dash_price_t_p': 'Set Purchase Price',
                'dash_add_p_h': 'Add Product', 'dash_add_p_p': 'List for Sale',
                'dash_buyer_req_h': 'Buyer Requests', 'dash_buyer_req_p': 'View Demand',
                'dash_add_req_h': 'Post Request', 'dash_add_req_p': 'Request Goods',
                'dash_market_h': 'Local Market', 'dash_market_p': 'Farmer Products',
                'dash_my_listing': '‚ö° My Listings (Products)',
                'dash_my_req': 'üì¢ My Requests (Needs)',
                'switch_farmer': 'Farmer', 'switch_trader': 'Trader', 'switch_reset': 'üö´ New Registration',
                'profile_title': 'My Profile',
                'label_name_p': 'Name:', 'label_phone_p': 'Phone Number:', 'label_taluka_p': 'Taluka:', 'label_role_p': 'Role:',
                'btn_back': 'Go Back',
                'buyer_req_title': 'Buyer Requests', 'buyer_req_subtitle': 'Traders demanding your goods (Contact immediately).',
                'market_title': 'üõí Local Farmer Market', 'market_subtitle': 'Available goods listed by farmers.',
                'subsidy_portal_title': 'Government Schemes Portal', 'subsidy_portal_subtitle': 'Major schemes matched to your role.',
                'list_product_form_title': 'Add New Product', 'list_product_form_subtitle': 'Enter details and price for sale.',
                'list_p_name_l': 'Product Name:', 'list_p_qty_l': 'Quantity (Kg/Quintal):', 'list_p_price_l': 'Sale Price (‚Çπ per unit):',
                'btn_list_market': 'List on Marketplace',
                'list_req_form_title': 'Post Purchase Request', 'list_req_form_subtitle': 'What you are looking for and your shop details.',
                'list_s_name_l': 'Shop/Company Name:', 'list_s_needs_l': 'What goods do you need?',
                'btn_publish_req': 'Publish Request',
                'prod_planner_title': 'Production Planner', 'prod_planner_subtitle': 'Select your soil type and expected rainfall:',
                'label_soil': 'Soil Type:', 'label_rain': 'Expected Rainfall:',
                'btn_get_reco': 'Get Recommendation', 'prod_initial_text': 'Press the button above for recommendations.',
                'price_title': 'üìà Sale & Price Analysis', 'price_subtitle': 'Enter your cost and price information for market analysis.',
                'list_p_name_l_p': 'Product Name:', 'list_p_qty_l_p': 'Quantity (Kg/L):', 'price_cost_l': 'Production Cost (Cost/Kg - ‚Çπ):',
                'price_your_price_l': 'Your Expected Price (Your Price - ‚Çπ/Kg):', 'btn_analyze_price': 'Analyze Price & List',
                'price_select_p': '-- Select Product --', 'price_reco_h': 'Recommended Price Range',
                'price_reco_init': '**Press button to analyze**', 'price_reco_p': 'Based on market demand and cost.',
                'price_current_p1': '**Product:** --', 'price_current_p2': '**Live APMC Rate:** --', 'price_current_p3': '**Your Production Cost:** --',
                'knn_profit': 'Est. Profit:', 'knn_water': 'Water Need:', 'knn_match': 'Govt Scheme Matched!',
                'market_unit': '‚Çπ per Unit', 'market_seller': 'Seller:', 'market_qty': 'Kg', 'req_contact': 'üìû Contact',
                'req_needs': 'Needs:', 'req_trader': 'Trader:', 'req_shop': 'Shop:',
                'dash_my_products': 'My Listed Products', 'dash_my_requests': 'My Local Requests',
                'default_taluka_name': 'Shirur',
                'home_welcome': 'üëã Hello,',
                'home_welcome_role': 'Role'
            }
        };

        function getText(key) {
            // Returns the localized text or the key if translation is missing
            return LANGUAGES[currentLang][key] || key;
        }

        function switchLanguage() {
            // Toggle language code
            currentLang = currentLang === 'mr' ? 'en' : 'mr';
            localStorage.setItem('appLang', currentLang);
            // Re-render everything
            applyLanguage();
            // Go back to current screen to force rendering of dynamic content
            showScreen(document.querySelector('.screen.active').id);
        }

        function applyLanguage() {
            // Update static elements based on data-key attribute
            document.querySelectorAll('[data-key]').forEach(el => {
                el.innerHTML = getText(el.getAttribute('data-key'));
            });
            
            // Update the language toggle button text
            document.getElementById('lang-button').innerText = currentLang === 'mr' ? 'EN' : '‡§Æ‡§∞‡§æ‡§†‡•Ä';
        }

        // =================================================================
        // 2. DATASETS & RULES (Simulating Database)
        // =================================================================

        const NEIGHBORS = [
            { id: 1, soil: 'Black', rainfall: 'Medium', crop: 'Sugarcane', profit: 25, water: '‡§ú‡§æ‡§∏‡•ç‡§§', subsidy_key: 'HIGH_GRANT' },
            { id: 2, soil: 'Black', rainfall: 'Low', crop: 'Cotton', profit: 20, water: '‡§ï‡§Æ‡•Ä', subsidy_key: 'LOW_RISK' },
            { id: 3, soil: 'Black', rainfall: 'Medium', crop: 'Onion', profit: 18, water: '‡§Æ‡§ß‡•ç‡§Ø‡§Æ', subsidy_key: 'MAHADB_LINKED' },
            { id: 4, soil: 'Red', rainfall: 'High', crop: 'Mangoes (Horticulture)', profit: 30, water: '‡§Æ‡§ß‡•ç‡§Ø‡§Æ', subsidy_key: 'HORTICULTURE_SCHEME' },
            { id: 5, soil: 'Red', rainfall: 'Medium', crop: 'Groundnut', profit: 17, water: '‡§ï‡§Æ‡•Ä', subsidy_key: 'LOW_RISK' },
            { id: 6, soil: 'Red', rainfall: 'High', crop: 'Turmeric', profit: 22, water: '‡§ú‡§æ‡§∏‡•ç‡§§', subsidy_key: 'HIGH_GRANT' },
            { id: 7, soil: 'Alluvial', rainfall: 'High', crop: 'Paddy (Rice)', profit: 15, water: '‡§ú‡§æ‡§∏‡•ç‡§§', subsidy_key: 'LOW_RISK' },
            { id: 10, soil: 'Alluvial', rainfall: 'Low', crop: 'Brinjal', profit: 16, water: '‡§ï‡§Æ‡•Ä', subsidy_key: 'NONE' },
        ];
        const SUBSIDY_SCHEMES = { 
            'HIGH_GRANT': { scheme_name: '‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§Æ‡§Ç‡§§‡•ç‡§∞‡•Ä ‡§ï‡•É‡§∑‡•Ä ‡§Ö‡§®‡•Å‡§¶‡§æ‡§®', benefit: '30% ‡§≠‡§æ‡§Ç‡§°‡§µ‡§≤‡•Ä ‡§Ö‡§®‡•Å‡§¶‡§æ‡§®', color: '#28a745', link: 'https://krishi.maharashtra.gov.in/en/schemes' },
            'MAHADB_LINKED': { scheme_name: '‡§Æ‡§π‡§æ‡§®‡§ø‡§∞‡•ç‡§Æ‡§ø‡§§‡•Ä ‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤', benefit: '‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§ñ‡§∞‡•á‡§¶‡•Ä ‡§π‡§Æ‡•Ä', color: '#17a2b8', link: 'https://mahadbtmahait.gov.in/Home/Index' },
            'HORTICULTURE_SCHEME': { scheme_name: '‡§´‡§≥‡§¨‡§æ‡§ó‡§æ ‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§Ø‡•ã‡§ú‡§®‡§æ', benefit: '‡•´‡•¶% ‡§†‡§ø‡§¨‡§ï ‡§∏‡§ø‡§Ç‡§ö‡§® ‡§Ö‡§®‡•Å‡§¶‡§æ‡§®', color: '#28a745', link: 'https://horticulture.maharashtra.gov.in/' },
            'LOW_RISK': { scheme_name: '‡§™‡•Ä‡§ï ‡§µ‡§ø‡§Æ‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ', benefit: '‡§∂‡•Ç‡§®‡•ç‡§Ø ‡§§‡•á ‡§ï‡§Æ‡•Ä ‡§™‡•ç‡§∞‡•Ä‡§Æ‡§ø‡§Ø‡§Æ', color: '#ffc107', link: 'https://pmfby.gov.in/' },
            'NONE': { scheme_name: '‡§∏‡§ß‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§£‡§§‡•Ä‡§π‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§æ‡§π‡•Ä', benefit: '‡§∏‡•ç‡§•‡§æ‡§®‡§ø‡§ï ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä/‡§ó‡•ç‡§∞‡§æ‡§Æ‡§∏‡•á‡§µ‡§ï ‡§§‡§™‡§æ‡§∏‡§æ', color: '#dc3545', link: '#' }
        };
        const APMC_LIVE_RATES = {
            'Tomato': 25.50, 'Onion': 18.00, 'Turmeric': 90.00, 'Sugarcane': 35.00, 'Default': 30.00
        };
        const PROFIT_RULES = {
            COST_MARKUP_PERCENT: 0.15, MIN_PROFIT_MARGIN: 0.20, RANGE_SPREAD: 0.05
        };
        const STATIC_ACCOUNTS = {
            'farmer': { userName: '‡§∞‡§Æ‡§æ ‡§™‡§æ‡§ü‡•Ä‡§≤', userRole: 'Farmer/Seller', userPhone: '9876543210', userTaluka: '‡§∂‡§ø‡§∞‡•Ç‡§∞' },
            'trader': { userName: '‡§Æ‡•ã‡§π‡§® ‡§ü‡•ç‡§∞‡•á‡§°‡§∞‡•ç‡§∏', userRole: 'Trader', userPhone: '9988776655', userTaluka: '‡§¶‡•å‡§Ç‡§°' }
        };
        const TRADER_DUMMY_REQUESTS = [
            { shopName: '‡§∏‡§æ‡§à ‡§ï‡•ã‡§≤‡•ç‡§° ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú', needs: '5000 ‡§ï‡§ø‡§≤‡•ã ‡§π‡§≥‡§¶ (Urgent)', trader: '‡§®‡§ø‡§ñ‡§ø‡§≤', phone: '9000111222', taluka: '‡§¨‡§æ‡§∞‡§æ‡§Æ‡§§‡•Ä', date: '04/10/2025' },
            { shopName: '‡§ó‡§£‡•á‡§∂ ‡§ï‡§ø‡§∞‡§æ‡§£‡§æ', needs: '100 ‡§ï‡§ø‡§≤‡•ã ‡§ü‡•ã‡§Æ‡•Ö‡§ü‡•ã', trader: '‡§∏‡•Å‡§∞‡•á‡§∂', phone: '9000333444', taluka: '‡§∂‡§ø‡§∞‡•Ç‡§∞', date: '05/10/2025' },
        ];
        const FARMER_DUMMY_PRODUCTS = [
            { product: '‡§¶‡•á‡§∂‡•Ä ‡§ï‡§æ‡§Ç‡§¶‡§æ', quantity: 200, price: 21.00, seller: '‡§¨‡§æ‡§≥‡§æ‡§∏‡§æ‡§π‡•á‡§¨', phone: '9111222333', taluka: '‡§ú‡•Å‡§®‡•ç‡§®‡§∞', date: '04/10/2025' },
            { product: '‡§ä‡§∏ (Sugarcane)', quantity: 15, price: 34.00, seller: '‡§∏‡§Ç‡§¶‡•Ä‡§™', phone: '9555666777', taluka: '‡§¶‡•å‡§Ç‡§°', date: '05/10/2025' },
        ];

        // =================================================================
        // 3. CORE UTILITY FUNCTIONS (Needed for hoisting and immediate calls)
        // =================================================================
        
        function getProfileData() {
            return {
                userName: localStorage.getItem('userName'),
                userRole: localStorage.getItem('userRole'),
                userPhone: localStorage.getItem('userPhone'),
                userTaluka: localStorage.getItem('userTaluka')
            };
        }

        function getListings(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function saveListings(key, listings) {
            localStorage.setItem(key, JSON.stringify(listings));
        }

        function goBack() {
            const userRole = localStorage.getItem('userRole');
            if (userRole === 'Farmer/Seller') { showScreen('farmer-dashboard'); } 
            else if (userRole === 'Trader') { showScreen('trader-dashboard'); } 
            else { showScreen('onboarding'); }
        }

        function updateDashboardHeaders(name, role) {
            const taluka = localStorage.getItem('userTaluka') || getText('default_taluka_name');
            const welcomeId = role === 'Farmer/Seller' ? 'farmer-welcome' : 'trader-welcome';
            const infoId = role === 'Farmer/Seller' ? 'farmer-info-display' : 'trader-info-display';
            
            if(document.getElementById(welcomeId)) { 
                document.getElementById(welcomeId).innerHTML = `${getText('home_welcome')} ${name}!`;
                document.getElementById(infoId).innerHTML = `${getText('home_welcome_role')}: ${role} | ${getText('label_taluka_p')}: ${taluka}`;
            }
        }

        function initializeDummyData() {
            if (!localStorage.getItem('dummySeeded')) {
                saveListings('farmProducts', FARMER_DUMMY_PRODUCTS);
                saveListings('traderShops', TRADER_DUMMY_REQUESTS);
                localStorage.setItem('dummySeeded', 'true');
            }
        }

        function checkUserStatus() {
            const { userName, userRole } = getProfileData();
            if (userRole) {
                updateDashboardHeaders(userName, userRole);
                showScreen(userRole === 'Farmer/Seller' ? 'farmer-dashboard' : 'trader-dashboard');
            } else if (userName) {
                showScreen('role-select');
            } else {
                showScreen('onboarding');
            }
        }
        
        // =================================================================
        // 4. NAVIGATION AND STATE LOGIC
        // =================================================================
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            document.getElementById('quick-switch-modal').style.display = 'none';

            // DYNAMIC TITLE UPDATE
            const titleElement = document.getElementById(screenId).querySelector('h2[data-key]');
            const headerTitle = titleElement ? getText(titleElement.getAttribute('data-key')) : getText('app_title');
            document.getElementById('header-title').innerText = headerTitle;
            
            const hideHeader = (screenId === 'onboarding' || screenId === 'role-select');
            document.getElementById('app-header').style.display = hideHeader ? 'none' : 'flex';
            const backBtn = document.querySelector('.back-btn');
            if (backBtn) {
                backBtn.style.display = (screenId === 'loading' || hideHeader) ? 'none' : 'block';
            }

            // Render logic based on the destination screen
            if (screenId === 'farmer-dashboard') {
                renderFarmDashboard();
            } else if (screenId === 'trader-dashboard') {
                renderTraderDashboard();
            } else if (screenId === 'competition') {
                renderFarmerMarket(); 
            } else if (screenId === 'trader-requests-for-farmer') {
                renderTraderRequestsForFarmer();
            } else if (screenId === 'user-profile') { 
                fillProfileForm(); 
            } else if (screenId === 'subsidy-info-page') { 
                renderSubsidyInfo();
            }
            // Ensure static content updates its language after screen switch
            applyLanguage();
        }

        // --- AUTH/ONBOARDING FUNCTIONS ---

        function selectRole(role) {
            localStorage.setItem('userRole', role);
            const userName = localStorage.getItem('userName');
            
            updateDashboardHeaders(userName, role);
            showScreen(role === 'Farmer/Seller' ? 'farmer-dashboard' : 'trader-dashboard');
        }


        // --- PROFILE FUNCTIONS ---

        function showProfile() { 
            fillProfileForm(); 
            showScreen('user-profile'); 
        }

        function fillProfileForm() {
            document.getElementById('profile-name').value = localStorage.getItem('userName') || '';
            document.getElementById('profile-phone').value = localStorage.getItem('userPhone') || '';
            document.getElementById('profile-taluka').value = localStorage.getItem('userTaluka') || '';
            document.getElementById('profile-role').value = localStorage.getItem('userRole') || '';
        }

        // --- ACCOUNT SWITCHING ---

        function toggleQuickSwitchModal() {
            const modal = document.getElementById('quick-switch-modal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }

        function quickSwitchAccount(roleKey) {
            const accountData = STATIC_ACCOUNTS[roleKey];
            localStorage.clear();
            localStorage.setItem('userName', accountData.userName);
            localStorage.setItem('userRole', accountData.userRole);
            localStorage.setItem('userPhone', accountData.userPhone);
            localStorage.setItem('userTaluka', accountData.userTaluka);
            
            // Reloads the app state for the new user
            checkUserStatus(); 
        }

        // =================================================================
        // 5. FEATURE LOGIC (Updated to use getText())
        // =================================================================

        // --- KNN Production Planner ---
        function runKNN() {
            const userSoil = document.getElementById('soil-type').value;
            const userRainfall = document.getElementById('rainfall').value;
            const recommendationsDiv = document.getElementById('production-recommendations');
            
            // KNN Simulation Logic (unchanged)
            const soilMap = { 'Black': 3, 'Red': 2, 'Alluvial': 1 };
            const rainfallMap = { 'High': 3, 'Medium': 2, 'Low': 1 };
            const userFeature = [soilMap[userSoil], rainfallMap[userRainfall]];

            const neighborsWithDistance = NEIGHBORS.map(neighbor => {
                let distance = 0;
                if (soilMap[neighbor.soil] !== userFeature[0]) distance += 1;
                if (rainfallMap[neighbor.rainfall] !== userFeature[1]) distance += 1;
                distance -= (neighbor.profit / 100); 
                return { ...neighbor, distance: distance };
            });

            const K = 3;
            neighborsWithDistance.sort((a, b) => {
                if (a.distance !== b.distance) { return a.distance - b.distance; }
                return b.profit - a.profit; 
            });
            const topRecommendations = neighborsWithDistance.slice(0, K);
            let htmlContent = '';
            
            topRecommendations.forEach((reco, index) => {
                const rankText = index === 0 ? 'ü•á' : (index === 1 ? 'ü•à' : 'ü•â');
                const bestClass = index === 0 ? 'best' : '';
                const subsidyInfo = SUBSIDY_SCHEMES[reco.subsidy_key];
                
                htmlContent += `
                    <div class="reco-item ${bestClass}">
                        <span class="reco-icon">${rankText}</span>
                        <h4>${reco.crop}</h4>
                        <p>üî• **${getText('knn_profit')}:** ${reco.profit}%</p>
                        <p>üíß **${getText('knn_water')}:** ${reco.water}</p>
                        <div class="subsidy-box" style="border-left-color: ${subsidyInfo.color};">
                            **${getText('knn_match')}!**
                            <span class="scheme-name">Scheme: ${subsidyInfo.scheme_name}</span>
                            <span class="scheme-name">Benefit: ${subsidyInfo.benefit}</span>
                        </div>
                    </div>
                `;
            });
            recommendationsDiv.innerHTML = htmlContent;
        }

        // --- Pricing Advisor ---
        function runPricingAdvisor() {
            const productName = document.getElementById('product-select').value;
            const costInput = parseFloat(document.getElementById('cost').value);
            const quantityInput = parseFloat(document.getElementById('quantity').value);
            const userPriceInput = parseFloat(document.getElementById('user-price-input').value);
            
            if (!productName || isNaN(costInput) || isNaN(quantityInput) || isNaN(userPriceInput)) {
                alert(currentLang === 'mr' ? "‡§ï‡•É‡§™‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§®‡§ø‡§µ‡§°‡§æ ‡§Ü‡§£‡§ø ‡§∏‡§∞‡•ç‡§µ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ‡§§‡•ç‡§Æ‡§ï ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≠‡§∞‡§æ‡•§" : "Please select a product and fill in all numerical information."); 
                return;
            }

            const liveApmcRate = APMC_LIVE_RATES[productName] || APMC_LIVE_RATES['Default'];
            const basePrice = liveApmcRate;
            const costPlusMarkup = costInput * (1 + PROFIT_RULES.COST_MARKUP_PERCENT);
            const priceWithMinProfit = costInput / (1 - PROFIT_RULES.MIN_PROFIT_MARGIN);
            const optimalPrice = Math.ceil(Math.max(basePrice, costPlusMarkup, priceWithMinProfit));

            const spreadAmount = optimalPrice * PROFIT_RULES.RANGE_SPREAD;
            const lowerBound = Math.floor(optimalPrice - spreadAmount);
            const upperBound = Math.ceil(optimalPrice + spreadAmount);

            let comparisonAlertHTML = '';
            let comparisonClass = '';
            
            // Logic for comparison alerts (updated to use getText)
            if (userPriceInput < lowerBound * 0.95) { 
                comparisonClass = 'alert-low';
                comparisonAlertHTML = currentLang === 'mr' ? `**‚ùå ‡§∏‡§æ‡§µ‡§ß ‡§∞‡§π‡§æ!** ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§¶‡§∞ ‡§¨‡§æ‡§ú‡§æ‡§∞‡§æ‡§™‡•á‡§ï‡•ç‡§∑‡§æ **‡§ñ‡•Ç‡§™ ‡§ï‡§Æ‡•Ä** ‡§Ü‡§π‡•á‡•§ ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§≤‡§æ ‚Çπ${lowerBound.toFixed(2)} ‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§ ‡§®‡§´‡§æ ‡§Æ‡§ø‡§≥‡•Ç ‡§∂‡§ï‡§§‡•ã‡•§` : `**‚ùå Warning!** Your price is **too low**. You could potentially earn up to ‚Çπ${lowerBound.toFixed(2)}.`;
            } else if (userPriceInput > upperBound * 1.1) { 
                comparisonClass = 'alert-high';
                comparisonAlertHTML = currentLang === 'mr' ? `**‚ö†Ô∏è ‡§ú‡§æ‡§∏‡•ç‡§§ ‡§¶‡§∞!** ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§¶‡§∞ ‡§¨‡§æ‡§ú‡§æ‡§∞‡§æ‡§§ ‡§ü‡§ø‡§ï‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä‡•§ ‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§ï‡•á‡§≤‡•á‡§≤‡•á ‡§¶‡§∞ ‡§µ‡§æ‡§™‡§∞‡§æ‡•§` : `**‚ö†Ô∏è Too High!** Your price won't be competitive. Use the recommended range.`;
            } else { 
                comparisonClass = 'alert-ok';
                comparisonAlertHTML = currentLang === 'mr' ? `**‚úÖ ‡§¶‡§∞ ‡§Ø‡•ã‡§ó‡•ç‡§Ø!** ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§¶‡§∞ ‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§ï‡•á‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä‡§§ ‡§Ü‡§π‡•á‡•§` : `**‚úÖ Price is Good!** Your price is within the recommended range.`;
            }

            document.querySelector('#pricing .price-range').innerHTML = 
                `**‚Çπ ${lowerBound.toFixed(2)} - ‚Çπ ${upperBound.toFixed(2)} / ${currentLang === 'mr' ? '‡§ï‡§ø‡§≤‡•ã' : 'Kg'}**`;
            
            document.getElementById('price-comparison-alert').className = `comparison-alert ${comparisonClass}`;
            document.getElementById('price-comparison-alert').innerHTML = comparisonAlertHTML;
            
            document.querySelector('#pricing .current-market-data').innerHTML = 
                `${getText('price_current_p1')}: ${productName} (${quantityInput} ${getText('market_qty')}) <br>` +
                `${getText('price_current_p2')}: ‚Çπ ${liveApmcRate.toFixed(2)} / ${currentLang === 'mr' ? '‡§ï‡§ø‡§≤‡•ã' : 'Kg'} <br>` +
                `${getText('price_current_p3')}: ‚Çπ ${costInput.toFixed(2)} / ${currentLang === 'mr' ? '‡§ï‡§ø‡§≤‡•ã' : 'Kg'}`;

            document.getElementById('price-result-message').style.display = 'block';
        }

        // --- Marketplace Rendering Functions (Local Storage) ---

        function renderFarmDashboard() { 
            const myName = localStorage.getItem('userName');
            const allProducts = getListings('farmProducts');
            const myProducts = allProducts.filter(p => p.seller === myName);
            const container = document.getElementById('my-farm-listings');
            const emptyText = currentLang === 'mr' ? '‡§∏‡§ß‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§Æ‡§æ‡§≤ ‡§∏‡•Ç‡§ö‡•Ä‡§¨‡§¶‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä‡•§' : 'No products currently listed.';

            if (myProducts.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-600">${emptyText}</p>`;
                return;
            }

            container.innerHTML = myProducts.map(p => `
                <div class="reco-item comp-item p-3 shadow-sm border-l-4 border-green-500">
                    <h4 class="font-bold">${p.product} (${p.quantity} ${getText('market_qty')})</h4>
                    <p class="text-sm text-gray-700">üí∞ ${getText('price_your_price_l')}: ‚Çπ ${p.price} / ${getText('market_unit')}</p>
                    <p class="text-xs text-gray-500">üìç ${currentLang === 'mr' ? '‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§§‡§æ‡§∞‡•Ä‡§ñ' : 'Listing Date'}: ${p.date}</p>
                </div>
            `).join('');
        }

        function renderTraderDashboard() {
            const myName = localStorage.getItem('userName');
            const allRequests = getListings('traderShops');
            const myRequests = allRequests.filter(r => r.trader === myName);
            const container = document.getElementById('my-trader-requests');
            const emptyText = currentLang === 'mr' ? '‡§∏‡§ß‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§£‡§§‡•Ä‡§π‡•Ä ‡§ñ‡§∞‡•á‡§¶‡•Ä ‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§≤‡•á‡§≤‡•Ä ‡§®‡§æ‡§π‡•Ä‡•§' : 'No purchase requests currently recorded.';

            if (myRequests.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-600">${emptyText}</p>`;
                return;
            }

            container.innerHTML = myRequests.map(r => `
                <div class="reco-item comp-item p-3 shadow-sm border-l-4 border-blue-500">
                    <h4 class="font-bold">${r.shopName}</h4>
                    <p class="text-sm text-gray-700">üîç ${getText('req_needs')}: ${r.needs}</p>
                    <p class="text-xs text-gray-500">üìç ${currentLang === 'mr' ? '‡§§‡§æ‡§∞‡•Ä‡§ñ' : 'Date'}: ${r.date}</p>
                </div>
            `).join('');
        }

        function renderTraderRequestsForFarmer() {
            const allRequests = getListings('traderShops'); 
            const container = document.getElementById('trader-request-listings');
            const emptyText = currentLang === 'mr' ? '‡§∏‡§ß‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§£‡§§‡•Ä‡§π‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡•Ä ‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä‡•§' : 'No trader requests available.';

            if (allRequests.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-600">${emptyText}</p>`;
                return;
            }

            container.innerHTML = allRequests.map(r => `
                <div class="reco-item best-price p-3 shadow-md bg-blue-50">
                    <h4 class="text-lg font-bold text-blue-800">${r.shopName}</h4>
                    <p class="text-sm text-gray-700 mb-2">üîç ${getText('req_needs')}: **${r.needs}**</p>
                    <p class="text-xs text-gray-600">üöö ${getText('req_trader')}: ${r.trader} (${r.taluka})</p>
                    <div class="subsidy-box mt-2 border-l-4 border-blue-800 bg-white">
                        **${getText('req_contact')}:** <a href="tel:${r.phone}" class="text-blue-600 font-bold">${r.phone}</a>
                    </div>
                </div>
            `).join('');
        }

        function renderFarmerMarket() {
            const allProducts = getListings('farmProducts'); 
            const container = document.getElementById('farmer-market-listings');
            const emptyText = currentLang === 'mr' ? '‡§∏‡§ß‡•ç‡§Ø‡§æ ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§Æ‡§æ‡§≤ ‡§∏‡•Ç‡§ö‡•Ä‡§¨‡§¶‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä‡•§' : 'No goods currently listed for sale.';

            if (allProducts.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-600">${emptyText}</p>`;
                return;
            }

            container.innerHTML = allProducts.map(p => `
                <div class="reco-item best p-3 shadow-md bg-green-50">
                    <span class="reco-icon">üõí</span>
                    <h4 class="text-lg font-bold text-green-800">${p.product} | ${p.quantity} ${getText('market_qty')}</h4>
                    <p class="text-sm text-gray-700 mb-2">üí∞ ${currentLang === 'mr' ? '‡§Æ‡§æ‡§ó‡§ø‡§§‡§≤‡•á‡§≤‡§æ ‡§¶‡§∞' : 'Asking Price'}: **‚Çπ ${p.price} / ${getText('market_unit')}**</p>
                    <p class="text-xs text-gray-600">üßë‚Äçüåæ ${getText('market_seller')}: ${p.seller} (${p.taluka})</p>
                    <div class="subsidy-box mt-2 border-l-4 border-green-800 bg-white">
                        **${getText('req_contact')}:** <a href="tel:${p.phone}" class="text-green-600 font-bold">${p.phone}</a>
                    </div>
                </div>
            `).join('');
        }

        function renderSubsidyInfo() {
            const container = document.getElementById('general-subsidy-list');
            let htmlContent = '';

            for (const key in SUBSIDY_SCHEMES) {
                const scheme = SUBSIDY_SCHEMES[key];
                if (key === 'NONE') continue; 

                const statusText = scheme.color === '#28a745' ? (currentLang === 'mr' ? '‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§Ü‡§£‡§ø ‡§â‡§ö‡•ç‡§ö ‡§≤‡§æ‡§≠' : 'Active & High Benefit') : (currentLang === 'mr' ? '‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø' : 'Active');
                
                htmlContent += `
                    <div class="reco-item" style="border-left: 5px solid ${scheme.color};">
                        <h4>${scheme.scheme_name}</h4>
                        <p>üéÅ **${currentLang === 'mr' ? '‡§≤‡§æ‡§≠' : 'Benefit'}:** ${scheme.benefit}</p>
                        <p>‚úÖ **${currentLang === 'mr' ? '‡§∏‡•ç‡§•‡§ø‡§§‡•Ä' : 'Status'}:** ${statusText}</p>
                        <a href="${scheme.link}" target="_blank" class="action-btn view-detail-btn">${currentLang === 'mr' ? '‡§§‡§™‡§∂‡•Ä‡§≤ ‡§™‡§π‡§æ' : 'View Details'}</a>
                    </div>
                `;
            }
            container.innerHTML = htmlContent || `<p class="text-center text-gray-600">${currentLang === 'mr' ? '‡§∏‡§ß‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§£‡§§‡•Ä‡§π‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä‡•§' : 'No schemes available at this time.'}</p>`;
        }


        // =================================================================
        // 6. APP INITIALIZATION & EVENT LISTENERS
        // =================================================================

        function attachEventListeners() {
            // 1. Registration Form
            document.getElementById('reg-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('reg-name').value;
                const phone = document.getElementById('reg-phone').value;
                const taluka = document.getElementById('reg-taluka').value;
                
                localStorage.setItem('userName', name);
                localStorage.setItem('userPhone', phone);
                localStorage.setItem('userTaluka', taluka);
                showScreen('role-select');
            });

            // 2. Profile Edit Form 
            document.getElementById('profile-edit-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Save changes
                localStorage.setItem('userName', document.getElementById('profile-name').value);
                localStorage.setItem('userPhone', document.getElementById('profile-phone').value);
                localStorage.setItem('userTaluka', document.getElementById('profile-taluka').value);
                
                alert(currentLang === 'mr' ? "‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§§‡§™‡§∂‡•Ä‡§≤ ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ ‡§ú‡§§‡§® ‡§ï‡•á‡§≤‡§æ! (Simulation)" : "Profile details successfully saved! (Simulation)");
                goBack();
            });

            // 3. Farmer Listing Form
            document.getElementById('product-listing-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const product = document.getElementById('list-product').value;
                const qty = document.getElementById('list-qty').value;
                const price = document.getElementById('list-price').value;
                
                const newProduct = {
                    product: product, quantity: parseFloat(qty), price: parseFloat(price),
                    seller: localStorage.getItem('userName'), phone: localStorage.getItem('userPhone'),
                    taluka: localStorage.getItem('userTaluka'), date: new Date().toLocaleDateString('en-IN')
                };
                const currentListings = getListings('farmProducts');
                currentListings.unshift(newProduct);
                saveListings('farmProducts', currentListings);
                
                document.getElementById('product-listing-form').reset();
                alert(currentLang === 'mr' ? `‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ${product} ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•Ç‡§ö‡•Ä‡§¨‡§¶‡•ç‡§ß ‡§ù‡§æ‡§≤‡•á!` : `Product ${product} successfully listed!`);
                showScreen('farmer-dashboard');
            });

            // 4. Trader Listing Form
            document.getElementById('shop-listing-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const shopName = document.getElementById('list-shop-name').value;
                const needs = document.getElementById('list-needs').value;
                
                const newRequest = {
                    shopName: shopName, needs: needs,
                    trader: localStorage.getItem('userName'), phone: localStorage.getItem('userPhone'),
                    taluka: localStorage.getItem('userTaluka'), date: new Date().toLocaleDateString('en-IN')
                };

                const currentRequests = getListings('traderShops');
                currentRequests.unshift(newRequest);
                saveListings('traderShops', currentRequests);
                
                document.getElementById('shop-listing-form').reset();
                alert(currentLang === 'mr' ? `‡§ñ‡§∞‡•á‡§¶‡•Ä ‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä ${shopName} ‡§∏‡§æ‡§†‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§≤‡•Ä ‡§ó‡•á‡§≤‡•Ä!` : `Purchase request for ${shopName} has been recorded!`);
                showScreen('trader-dashboard');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            currentLang = localStorage.getItem('appLang') || 'mr';
            applyLanguage();
            initializeDummyData();
            attachEventListeners();
            checkUserStatus(); 
        });
    </script>
</body>
</html>
