<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gram-Labh Margdarshak (Prototype)</title>
    
    <!-- CSS STYLES (Inline for portability) -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .mobile-container { width: 100%; max-width: 400px; min-height: 800px; background-color: #ffffff; box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); border-radius: 25px; overflow: hidden; display: flex; flex-direction: column; }
        header { background-color: #007bff; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; font-weight: bold; border-top-left-radius: 25px; border-top-right-radius: 25px; }
        .back-btn { cursor: pointer; font-size: 1.5em; padding-right: 15px; }
        .user-profile { cursor: pointer; font-size: 1.2em; }
        .screen { padding: 20px; flex-grow: 1; overflow-y: auto; display: none; background-color: #ffffff; }
        .screen.active { display: block; }
        .welcome-text { color: #333; margin-top: 0; font-size: 1.4em; }
        .subtitle { color: #666; margin-bottom: 20px; font-size: 0.9em; }
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .card { background-color: #e6f0ff; border: 1px solid #007bff; border-radius: 12px; padding: 15px; cursor: pointer; transition: transform 0.2s; text-align: center; box-shadow: 0 4px 8px rgba(0, 123, 255, 0.1); }
        .card:hover { background-color: #cce0ff; transform: translateY(-2px); }
        .card h3 { margin-top: 0; margin-bottom: 5px; color: #007bff; font-size: 1.1em; }
        .card p { margin: 0; color: #555; font-size: 0.8em; }
        .card.special-card { background-color: #d8f5d8; border: 1px solid #28a745; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2); }
        .card.special-card h3 { color: #28a745; }
        .action-btn { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin-top: 15px; transition: background-color 0.2s; }
        .action-btn:hover { background-color: #218838; }
        .action-btn.view-detail-btn {
            display: inline-block; /* Treat the link like a small button */
            width: 100px;
            padding: 5px;
            font-size: 0.8em;
            margin-top: 5px;
            background-color: #007bff;
            text-decoration: none; /* Remove underline */
            color: white;
            border-radius: 6px;
            text-align: center;
        }

        .reco-item { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; }
        .reco-item.best { border-left: 5px solid #28a745; background-color: #d4edda; }
        .subsidy-box { margin-top: 10px; padding: 10px; background-color: #e6f0ff; border-radius: 4px; border-left: 5px solid; font-size: 0.9em; color: #333; font-weight: bold; line-height: 1.4; }
        .subsidy-box .scheme-name { font-weight: normal; color: #555; display: block; margin-top: 3px; }
        .profile-input input, .input-section input, .input-section select { width: 95%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; margin-bottom: 10px; display: block; }
        .input-section label { display: block; margin-bottom: 3px; font-weight: bold; color: #555; } /* Ensures labels are block and separate from input */
        .role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .role-card { background-color: #f7f7ff; border: 2px solid #007bff; padding: 25px; cursor: pointer; text-align: center; }
        .reco-item.best-price { border-left: 5px solid #ffc107; background-color: #fff8e6; }
        .price-range { font-size: 1.6em; color: #d89b00; font-weight: bold; margin: 5px 0; }
        .comparison-alert { padding: 12px; border-radius: 8px; font-weight: bold; font-size: 1em; line-height: 1.4; text-align: center; margin-bottom: 15px; }
        .comparison-alert.alert-ok { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .comparison-alert.alert-high { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .comparison-alert.alert-low { background-color: #ffeeb3; color: #856404; border: 1px solid #ffeeba; }
        .switch-btn { cursor: pointer; font-size: 1.5em; padding-left: 15px; }
        #quick-switch-modal { position: absolute; top: 60px; right: 15px; width: 220px; background: #ffffff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 1000; display: none; padding: 5px 0; }
        .modal-item { padding: 10px 15px; font-size: 0.9em; cursor: pointer; color: #333; transition: background-color 0.1s; }
        .modal-item:hover { background-color: #f0f0f0; }
        .modal-item.reset-btn { border-top: 1px solid #eee; color: #dc3545; }
        .lang-switch-btn { 
            background: none; 
            border: 1px solid white; 
            color: white; 
            padding: 5px 8px; 
            border-radius: 4px; 
            font-size: 0.7em; 
            font-weight: bold;
            margin-right: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <header id="app-header">
            <span class="back-btn" onclick="goBack()">тЖР</span>
            <span class="title" id="header-title" data-key="app_title">рдореБрдЦреНрдпрдкреГрд╖реНрда (Home)</span>
            
            <!-- NEW LANGUAGE SWITCH BUTTON -->
            <div style="display: flex; align-items: center;">
                <button class="lang-switch-btn" id="lang-button" onclick="switchLanguage()"></button>
                <span class="user-profile switch-btn" onclick="toggleQuickSwitchModal()">ЁЯСд</span>
            </div>
        </header>

        <!-- NEW QUICK SWITCH MODAL (For testing roles) -->
        <div id="quick-switch-modal">
            <div class="modal-item" onclick="quickSwitchAccount('farmer')">ЁЯзСтАНЁЯМ╛ <span data-key="switch_farmer">рд╢реЗрддрдХрд░реА (Farmer)</span></div>
            <div class="modal-item" onclick="quickSwitchAccount('trader')">ЁЯЪЪ <span data-key="switch_trader">рд╡реНрдпрд╛рдкрд╛рд░реА (Trader)</span></div>
            <div class="modal-item reset-btn" onclick="localStorage.clear(); checkUserStatus();"><span data-key="switch_reset">рдирд╡реАрди рдиреЛрдВрджрдгреА рдХрд░рд╛</span></div>
        </div>

        <!-- ========================================================== -->
        <!-- 1. ONBOARDING / AUTHENTICATION SCREENS -->
        <!-- ========================================================== -->
        <div class="screen active" id="loading">
            <h2 class="welcome-text text-center text-blue-600" data-key="loading_title">рд▓реЛрдб рд╣реЛрдд рдЖрд╣реЗ...</h2>
            <p class="subtitle text-center" data-key="loading_subtitle">рд╕реНрдерд╛рдирд┐рдХ рдбреЗрдЯрд╛ рддрдкрд╛рд╕рдд рдЖрд╣реЗ...</p>
        </div>
        <div class="screen" id="onboarding">
            <h2 class="welcome-text" style="color:#007bff;" data-key="welcome_title">ЁЯСЛ рдЧреНрд░рд╛рдо-рд▓рд╛рдн рдордзреНрдпреЗ рдЖрдкрд▓реЗ рд╕реНрд╡рд╛рдЧрдд!</h2>
            <p class="subtitle" data-key="register_subtitle">рд╕реЗрд╡рд╛ рд╡рд╛рдкрд░рдгреНрдпрд╛рд╕рд╛рдареА рдХреГрдкрдпрд╛ рдиреЛрдВрджрдгреА рдХрд░рд╛ред</p>
            <form id="reg-form">
                <div class="input-section">
                    <label for="reg-name" data-key="label_name">рдирд╛рд╡ (Full Name):</label>
                    <input type="text" id="reg-name" required placeholder="рдЙрджрд╛. рдЬрдп рдЬрдпрд╕реНрд╡рд╛рд▓" class="rounded p-2 border">
                </div>
                <div class="input-section">
                    <label for="reg-phone" data-key="label_phone">рдлреЛрди рдирдВрдмрд░ (Phone):</label>
                    <input type="tel" id="reg-phone" required placeholder="10 рдЕрдВрдХреА рдирдВрдмрд░" class="rounded p-2 border">
                </div>
                <div class="input-section">
                    <label for="reg-taluka" data-key="label_taluka">рддрд╛рд▓реБрдХрд╛ (Taluka):</label>
                    <input type="text" id="reg-taluka" required placeholder="рдЙрджрд╛. рд╢рд┐рд░реВрд░" class="rounded p-2 border">
                </div>
                <button type="submit" class="action-btn" data-key="btn_next">рдкреБрдвреАрд▓ рдЪрд░рдг (Next Step) тЖТ</button>
            </form>
        </div>

        <div class="screen" id="role-select">
            <h2 class="welcome-text" style="color:#007bff;" data-key="role_select_title">рдЖрдкрд▓реА рднреВрдорд┐рдХрд╛ рдирд┐рд╡рдбрд╛</h2>
            <p class="subtitle" data-key="role_select_subtitle">рддреБрдореНрд╣реА рдореБрдЦреНрдпрддрдГ рдХрд╛рдп рдЖрд╣рд╛рдд?</p>
            <div class="card-grid role-grid">
                <div class="card role-card" onclick="selectRole('Farmer/Seller')">
                    <h3>ЁЯзСтАНЁЯМ╛ <span data-key="role_farmer_h">рд╢реЗрддрдХрд░реА / рд╡рд┐рдХреНрд░реЗрддрд╛</span></h3>
                    <p data-key="role_farmer_p">рдЙрддреНрдкрд╛рджрди, рдХрд┐рдВрдордд рдЖрдгрд┐ рдЕрдиреБрджрд╛рди рд╕рд▓реНрд▓рд╛ рд╣рд╡рд╛ред</p>
                </div>
                <div class="card role-card" onclick="selectRole('Trader')">
                    <h3>ЁЯЪЪ <span data-key="role_trader_h">рд╡реНрдпрд╛рдкрд╛рд░реА / рдЦрд░реЗрджреАрджрд╛рд░</span></h3>
                    <p data-key="role_trader_p">рдмрд╛рдЬрд╛рд░ рджрд░, рдорд╛рдЧрдгреА рдЖрдгрд┐ рд▓реЙрдЬрд┐рд╕реНрдЯрд┐рдХреНрд╕ рдорд╛рд╣рд┐рддреА рд╣рд╡реАред</p>
                </div>
            </div>
        </div>

        <!-- ========================================================== -->
        <!-- 2. ROLE-SPECIFIC DASHBOARDS -->
        <!-- ========================================================== -->

        <!-- FARMER DASHBOARD -->
        <div class="screen" id="farmer-dashboard">
            <h2 class="welcome-text" id="farmer-welcome">ЁЯСЛ рдирдорд╕реНрддреЗ!</h2>
            <p class="subtitle" id="farmer-info-display"></p>
            <div class="card-grid role-feature-grid">
                <div class="card" onclick="showScreen('production')"><h3>ЁЯМ▒ <span data-key="dash_planner_h">рдирд┐рдпреЛрдЬрдХ</span></h3><p data-key="dash_planner_p">рдЙрддреНрдкрд╛рджрди рд╕рд▓реНрд▓рд╛</p></div>
                <div class="card special-card" onclick="showScreen('subsidy-info-page')"><h3>ЁЯТ░ <span data-key="dash_subsidy_h">рдЕрдиреБрджрд╛рди</span></h3><p data-key="dash_subsidy_p">рдпреЛрдЬрдирд╛ рддрдкрд╛рд╕рд╛</p></div>
                <div class="card" onclick="showScreen('pricing')"><h3>ЁЯУИ <span data-key="dash_price_h">рджрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг</span></h3><p data-key="dash_price_p">рдХрд┐рдВрдордд рдард░рд╡рд╛</p></div>
                <div class="card" onclick="showScreen('list-product-form')"><h3>тЮХ <span data-key="dash_add_p_h">рдЙрддреНрдкрд╛рджрди рдЬреЛрдбрд╛</span></h3><p data-key="dash_add_p_p">рд╡рд┐рдХреНрд░реАрд╕рд╛рдареА рд▓рд┐рд╕реНрдЯ рдХрд░рд╛</p></div>
                <div class="card" onclick="showScreen('trader-requests-for-farmer')"><h3>ЁЯУж <span data-key="dash_buyer_req_h">рдЦрд░реЗрджреАрджрд╛рд░ рд╡рд┐рдирдВрддреНрдпрд╛</span></h3><p data-key="dash_buyer_req_p">рдорд╛рдЧрдгреА рдкрд╣рд╛</p></div>
            </div>
            <div class="demand-radar mt-6 bg-yellow-100 p-4 rounded-xl border-l-4 border-yellow-500">
                <h3 class="text-yellow-900 font-bold mb-2" data-key="dash_my_listing">тЪб рдорд╛рдЭреА рд▓рд┐рд╕реНрдЯрд┐рдВрдЧ (My Products)</h3>
                <div class="reco-list" id="my-farm-listings"></div>
            </div>
        </div>

        <!-- TRADER DASHBOARD -->
        <div class="screen" id="trader-dashboard">
            <h2 class="welcome-text" id="trader-welcome">ЁЯСЛ рдирдорд╕реНрддреЗ!</h2>
            <p class="subtitle" id="trader-info-display"></p>
            <div class="card-grid role-feature-grid">
                <div class="card" onclick="showScreen('list-shop-form')"><h3>ЁЯУЭ <span data-key="dash_add_req_h">рд╡рд┐рдирдВрддреА рдиреЛрдВрджрд╡рд╛</span></h3><p data-key="dash_add_req_p">рдорд╛рд▓ рдЦрд░реЗрджреАрдЪреА рд╡рд┐рдирдВрддреА</p></div>
                <div class="card special-card" onclick="showScreen('competition')"><h3>ЁЯЫТ <span data-key="dash_market_h">рд╕реНрдерд╛рдирд┐рдХ рдмрд╛рдЬрд╛рд░рдкреЗрда</span></h3><p data-key="dash_market_p">рд╢реЗрддрдХрд░реА рдЙрддреНрдкрд╛рджрдиреЗ</p></div>
                <div class="card" onclick="showScreen('pricing')"><h3>ЁЯУИ <span data-key="dash_price_h">рджрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг</span></h3><p data-key="dash_price_t_p">рдЦрд░реЗрджреАрдЪреА рдХрд┐рдВрдордд рдард░рд╡рд╛</p></div>
            </div>
            <div class="demand-radar mt-6 bg-blue-100 p-4 rounded-xl border-l-4 border-blue-500">
                <h3 class="text-blue-900 font-bold mb-2" data-key="dash_my_req">ЁЯУв рдорд╛рдЭреНрдпрд╛ рд╡рд┐рдирдВрддреНрдпрд╛ (My Requests)</h3>
                <div class="reco-list" id="my-trader-requests"></div>
            </div>
        </div>
        
        <!-- ========================================================== -->
        <!-- 3. FEATURE SCREENS -->
        <!-- ========================================================== -->

        <!-- USER PROFILE SCREEN -->
        <div class="screen" id="user-profile">
            <h2 class="text-blue-600" data-key="profile_title">рдорд╛рдЭрд╛ рдкреНрд░реЛрдлрд╛рдЗрд▓ (My Profile)</h2>
            <form id="profile-edit-form">
                <div class="profile-input">
                    <label data-key="label_name_p">рдирд╛рд╡:</label>
                    <input type="text" id="profile-name" readonly>
                </div>
                <div class="profile-input">
                    <label data-key="label_phone_p">рдлреЛрди рдирдВрдмрд░:</label>
                    <input type="tel" id="profile-phone" readonly>
                </div>
                <div class="profile-input">
                    <label data-key="label_taluka_p">рддрд╛рд▓реБрдХрд╛:</label>
                    <input type="text" id="profile-taluka" readonly>
                </div>
                <div class="profile-input">
                    <label data-key="label_role_p">рднреВрдорд┐рдХрд╛:</label>
                    <input type="text" id="profile-role" readonly>
                </div>
                <button type="button" class="action-btn" onclick="goBack()" data-key="btn_back">рдорд╛рдЧреЗ рдЬрд╛</button>
            </form>
        </div>

        <!-- FARMER: TRADER REQUESTS SCREEN -->
        <div class="screen" id="trader-requests-for-farmer">
            <h2 class="text-blue-600" data-key="buyer_req_title">рдЦрд░реЗрджреАрджрд╛рд░ рд╡рд┐рдирдВрддреНрдпрд╛ (Buyer Requests)</h2>
            <p class="subtitle" data-key="buyer_req_subtitle">рддреБрдордЪреНрдпрд╛ рдорд╛рд▓рд╛рдЪреА рдорд╛рдЧрдгреА рдХрд░рдгрд╛рд░реЗ рд╡реНрдпрд╛рдкрд╛рд░реАред</p>
            <div class="reco-list" id="trader-request-listings"></div>
        </div>

        <!-- TRADER: MARKETPLACE SCREEN -->
        <div class="screen" id="competition">
            <h2 class="text-blue-600" data-key="market_title">ЁЯЫТ рд╕реНрдерд╛рдирд┐рдХ рд╢реЗрддрдХрд░реА рдмрд╛рдЬрд╛рд░рдкреЗрда</h2>
            <p class="subtitle" data-key="market_subtitle">рд╡рд┐рдХреНрд░реАрд╕рд╛рдареА рдЙрдкрд▓рдмреНрдз рдЕрд╕рд▓реЗрд▓реА рд╢реЗрддрдХрд░реА рдЙрддреНрдкрд╛рджрдиреЗред</p>
            <div class="reco-list" id="farmer-market-listings"></div>
        </div>
        
        <!-- SUBSIDY INFO PAGE -->
        <div class="screen" id="subsidy-info-page">
            <h2 class="text-green-600" data-key="subsidy_portal_title">рд╕рд░рдХрд╛рд░реА рдпреЛрдЬрдирд╛ рдкреЛрд░реНрдЯрд▓</h2>
            <p class="subtitle" data-key="subsidy_portal_subtitle">рддреБрдордЪреНрдпрд╛ рднреВрдорд┐рдХреЗрдиреБрд╕рд╛рд░ рдЬреБрд│рдгрд╛рд▒реНрдпрд╛ рдкреНрд░рдореБрдЦ рдпреЛрдЬрдирд╛ред</p>
            <div class="reco-list" id="general-subsidy-list"></div>
        </div>

        <!-- FARMER: LIST PRODUCT FORM -->
        <div class="screen" id="list-product-form">
            <h2 class="text-blue-600" data-key="list_product_form_title">рдирд╡реАрди рдЙрддреНрдкрд╛рджрди рдЬреЛрдбрд╛</h2>
            <p class="subtitle" data-key="list_product_form_subtitle">рд╡рд┐рдХреНрд░реАрд╕рд╛рдареА рдЙрдкрд▓рдмреНрдз рдорд╛рд▓ рдЖрдгрд┐ рдХрд┐рдВрдордд рдорд╛рд╣рд┐рддреА рдкреНрд░рд╡рд┐рд╖реНрдЯ рдХрд░рд╛ред</p>
            <form id="product-listing-form">
                <div class="input-section">
                    <label for="list-product" data-key="list_p_name_l">рдЙрддреНрдкрд╛рджрдирд╛рдЪреЗ рдирд╛рд╡:</label>
                    <input type="text" id="list-product" required placeholder="рдЙрджрд╛. рд╣рд│рдж рдкрд╛рд╡рдбрд░">
                </div>
                <div class="input-section">
                    <label for="list-qty" data-key="list_p_qty_l">рдЙрдкрд▓рдмреНрдз рдорд╛рддреНрд░рд╛ (Kg/Quintal):</label>
                    <input type="number" id="list-qty" required placeholder="рдЙрджрд╛. 500">
                </div>
                <div class="input-section">
                    <label for="list-price" data-key="list_p_price_l">рд╡рд┐рдХреНрд░реА рджрд░ (тВ╣ рдкреНрд░рддрд┐ рдпреБрдирд┐рдЯ):</label>
                    <input type="number" id="list-price" required placeholder="рдЙрджрд╛. 75">
                </div>
                <button type="submit" class="action-btn" data-key="btn_list_market">рдмрд╛рдЬрд╛рд░рдкреЗрдареЗрдд рд╕реВрдЪреАрдмрджреНрдз рдХрд░рд╛</button>
            </form>
        </div>

        <!-- TRADER: LIST SHOP REQUEST FORM -->
        <div class="screen" id="list-shop-form">
            <h2 class="text-blue-600" data-key="list_req_form_title">рдЦрд░реЗрджреА рд╡рд┐рдирдВрддреА рдиреЛрдВрджрд╡рд╛</h2>
            <p class="subtitle" data-key="list_req_form_subtitle">рддреБрдореНрд╣реА рдХрд╛рдп рд╢реЛрдзрдд рдЖрд╣рд╛рдд рдЖрдгрд┐ рддреБрдордЪреНрдпрд╛ рджреБрдХрд╛рдирд╛рдЪреА рдорд╛рд╣рд┐рддреА рджреНрдпрд╛ред</p>
            <form id="shop-listing-form">
                <div class="input-section">
                    <label for="list-shop-name" data-key="list_s_name_l">рддреБрдордЪреНрдпрд╛ рджреБрдХрд╛рдирд╛рдЪреЗ/рд╕рдВрд╕реНрдереЗрдЪреЗ рдирд╛рд╡:</label>
                    <input type="text" id="list-shop-name" required placeholder="рдЙрджрд╛. рд╢реНрд░реАрд░рд╛рдо рдЯреНрд░реЗрдбрд░реНрд╕">
                </div>
                <div class="input-section">
                    <label for="list-needs" data-key="list_s_needs_l">рддреБрдореНрд╣рд╛рд▓рд╛ рдХреЛрдгрддреНрдпрд╛ рдорд╛рд▓рд╛рдЪреА рдЧрд░рдЬ рдЖрд╣реЗ?</label>
                    <input type="text" id="list-needs" required placeholder="рдЙрджрд╛. 1000 рдХрд┐рд▓реЛ рдХрд╛рдВрджрд╛">
                </div>
                <button type="submit" class="action-btn" data-key="btn_publish_req">рд╡рд┐рдирдВрддреА рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд░рд╛</button>
            </form>
        </div>
        
        <!-- Production and Pricing screens -->
        <div class="screen" id="production">
            <h2 class="text-blue-600" data-key="prod_planner_title">рдЙрддреНрдкрд╛рджрди рдирд┐рдпреЛрдЬрдХ (Production Planner)</h2>
            <p class="subtitle" data-key="prod_planner_subtitle">рддреБрдордЪрд╛ рдЬрдорд┐рдиреАрдЪрд╛ рдкреНрд░рдХрд╛рд░ рдЖрдгрд┐ рдЕрдкреЗрдХреНрд╖рд┐рдд рдкрд╛рдКрд╕ рдирд┐рд╡рдбрд╛:</p>

            <div class="input-section">
                <label for="soil-type" data-key="label_soil">рдЬрдорд┐рдиреАрдЪрд╛ рдкреНрд░рдХрд╛рд░ (Soil Type):</label>
                <select id="soil-type">
                    <option value="Black">рдХрд╛рд│реА рдорд╛рддреА (Black Soil)</option>
                    <option value="Red">рд▓рд╛рд▓ рдорд╛рддреА (Red Soil)</option>
                    <option value="Alluvial">рдЧрд╛рд│рд╛рдЪреА рдорд╛рддреА (Alluvial Soil)</option>
                </select>
            </div>
            <div class="input-section">
                <label for="rainfall" data-key="label_rain">рдЕрдкреЗрдХреНрд╖рд┐рдд рдкрд╛рдКрд╕ (Expected Rainfall):</label>
                <select id="rainfall">
                    <option value="High">рдЬрд╛рд╕реНрдд (High)</option>
                    <option value="Medium">рдордзреНрдпрдо (Medium)</option>
                    <option value="Low">рдХрдореА (Low)</option>
                </select>
            </div>

            <button class="action-btn" onclick="runKNN()" data-key="btn_get_reco">рд╢рд┐рдлрд╛рд░рд╕ рдорд┐рд│рд╡рд╛ (Get Recommendation)</button>

            <div class="reco-list" id="production-recommendations">
                <p style="text-align: center; color: #666;" data-key="prod_initial_text">рд╡рд░рдЪреЗ рдмрдЯрдг рджрд╛рдмреВрди рд╢рд┐рдлрд╛рд░рд╕ рдорд┐рд│рд╡рд╛ред</p>
            </div>
        </div>

        <div class="screen" id="pricing">
            <h2 class="text-blue-600" data-key="price_title">ЁЯУИ рд╡рд┐рдХреНрд░реА рдЖрдгрд┐ рджрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг</h2>
            <p class="subtitle" data-key="price_subtitle">рддреБрдордЪреНрдпрд╛ рдЙрддреНрдкрд╛рджрдирд╛рдЪрд╛ рдмрд╛рдЬрд╛рд░ рджрд░ рдЖрдгрд┐ рд╡рд┐рдХреНрд░реАрдЪреА рдорд╛рд╣рд┐рддреА рдкреНрд░рд╡рд┐рд╖реНрдЯ рдХрд░рд╛ред</p>

            <div class="input-section">
                <label for="product-select" data-key="list_p_name_l_p">рдЙрддреНрдкрд╛рджрдирд╛рдЪреЗ рдирд╛рд╡ (Product Name):</label>
                <select id="product-select" required>
                    <option value="" data-key="price_select_p">-- рдЙрддреНрдкрд╛рджрди рдирд┐рд╡рдбрд╛ --</option>
                    <option value="Tomato">рдЯреЙрдореЗрдЯреЛ (Tomato)</option>
                    <option value="Onion">рдХрд╛рдВрджрд╛ (Onion)</option>
                    <option value="Turmeric">рд╣рд│рдж (Turmeric)</option>
                    <option value="Sugarcane">рдКрд╕ (Sugarcane)</option>
                </select>
            </div>
            
            <div class="input-section">
                <label for="quantity" data-key="list_p_qty_l_p">рдЙрдкрд▓рдмреНрдз рдорд╛рддреНрд░рд╛ (Quantity - Kg/L):</label>
                <input type="number" id="quantity" value="100" required placeholder="рдЙрджрд╛ред 100">
            </div>

            <div class="input-section">
                <label for="cost" data-key="price_cost_l">рдЙрддреНрдкрд╛рджрди рдЦрд░реНрдЪ (Cost/Kg - тВ╣):</label>
                <input type="number" id="cost" value="15" required placeholder="рдЙрджрд╛ред 15">
            </div>

            <div class="input-section">
                <label for="user-price-input" data-key="price_your_price_l">рддреБрдордЪрд╛ рдЕрдкреЗрдХреНрд╖рд┐рдд рджрд░ (Your Price - тВ╣/Kg):</label>
                <input type="number" id="user-price-input" value="35" required placeholder="рдЙрджрд╛ред 35">
            </div>

            <button class="action-btn" onclick="runPricingAdvisor()" data-key="btn_analyze_price">рджрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рд╛ (Analyze Price & List)</button> 

            <div id="price-result-message" style="display:none; margin-top: 20px;">
                <div id="price-comparison-alert" class="comparison-alert"></div>
            </div>

            <div class="reco-list">
                <div class="reco-item best-price">
                    <h4 data-key="price_reco_h">рд╢рд┐рдлрд╛рд░рд╕ рдХреЗрд▓реЗрд▓рд╛ рджрд░ (Recommended Price Range)</h4>
                    <p class="price-range" data-key="price_reco_init">**рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рдмрдЯрдг рджрд╛рдмрд╛**</p>
                    <p class="small-text" data-key="price_reco_p">рдмрд╛рдЬрд╛рд░рд╛рддреАрд▓ рдорд╛рдЧрдгреА рдЖрдгрд┐ рдЦрд░реНрдЪрд╛рд╡рд░ рдЖрдзрд╛рд░рд┐рддред</p>
                </div>
            </div>
            
            <p class="current-market-data">
                <span data-key="price_current_p1">**рдЙрддреНрдкрд╛рджрди:** -- </span><br>
                <span data-key="price_current-p2">**рд▓рд╛рдЗрд╡реНрд╣ APMC рджрд░:** -- </span><br>
                <span data-key="price_current-p3">**рдЖрдкрд▓рд╛ рдЙрддреНрдкрд╛рджрди рдЦрд░реНрдЪ:** -- </span>
            </p>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // =================================================================
        // 1. LANGUAGE DATA & STATE
        // =================================================================

        let currentLang = localStorage.getItem('appLang') || 'mr';

        const LANGUAGES = {
            'mr': {
                'app_title': 'рдЧреНрд░рд╛рдо-рд▓рд╛рдн рдорд╛рд░реНрдЧрджрд░реНрд╢рдХ',
                'loading_title': 'рд▓реЛрдб рд╣реЛрдд рдЖрд╣реЗ...',
                'loading_subtitle': 'рд╕реНрдерд╛рдирд┐рдХ рдбреЗрдЯрд╛ рддрдкрд╛рд╕рдд рдЖрд╣реЗ...',
                'welcome_title': 'ЁЯСЛ рдЧреНрд░рд╛рдо-рд▓рд╛рдн рдордзреНрдпреЗ рдЖрдкрд▓реЗ рд╕реНрд╡рд╛рдЧрдд!',
                'register_subtitle': 'рд╕реЗрд╡рд╛ рд╡рд╛рдкрд░рдгреНрдпрд╛рд╕рд╛рдареА рдХреГрдкрдпрд╛ рдиреЛрдВрджрдгреА рдХрд░рд╛ред',
                'label_name': 'рдирд╛рд╡ (Full Name):', 'label_phone': 'рдлреЛрди рдирдВрдмрд░ (Phone):', 'label_taluka': 'рддрд╛рд▓реБрдХрд╛ (Taluka):',
                'btn_next': 'рдкреБрдвреАрд▓ рдЪрд░рдг тЖТ',
                'role_select_title': 'рдЖрдкрд▓реА рднреВрдорд┐рдХрд╛ рдирд┐рд╡рдбрд╛', 'role_select_subtitle': 'рддреБрдореНрд╣реА рдореБрдЦреНрдпрддрдГ рдХрд╛рдп рдЖрд╣рд╛рдд?',
                'role_farmer_h': 'рд╢реЗрддрдХрд░реА / рд╡рд┐рдХреНрд░реЗрддрд╛', 'role_farmer_p': 'рдЙрддреНрдкрд╛рджрди, рдХрд┐рдВрдордд рдЖрдгрд┐ рдЕрдиреБрджрд╛рди рд╕рд▓реНрд▓рд╛ рд╣рд╡рд╛ред',
                'role_trader_h': 'рд╡реНрдпрд╛рдкрд╛рд░реА / рдЦрд░реЗрджреАрджрд╛рд░', 'role_trader_p': 'рдмрд╛рдЬрд╛рд░ рджрд░, рдорд╛рдЧрдгреА рдЖрдгрд┐ рд▓реЙрдЬрд┐рд╕реНрдЯрд┐рдХреНрд╕ рдорд╛рд╣рд┐рддреА рд╣рд╡реАред',
                'dash_planner_h': 'рдирд┐рдпреЛрдЬрдХ', 'dash_planner_p': 'рдЙрддреНрдкрд╛рджрди рд╕рд▓реНрд▓рд╛',
                'dash_subsidy_h': 'рдЕрдиреБрджрд╛рди', 'dash_subsidy_p': 'рдпреЛрдЬрдирд╛ рддрдкрд╛рд╕рд╛',
                'dash_price_h': 'рджрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг', 'dash_price_p': 'рдХрд┐рдВрдордд рдард░рд╡рд╛', 'dash_price_t_p': 'рдЦрд░реЗрджреАрдЪреА рдХрд┐рдВрдордд рдард░рд╡рд╛',
                'dash_add_p_h': 'рдЙрддреНрдкрд╛рджрди рдЬреЛрдбрд╛', 'dash_add_p_p': 'рд╡рд┐рдХреНрд░реАрд╕рд╛рдареА рд▓рд┐рд╕реНрдЯ рдХрд░рд╛',
                'dash_buyer_req_h': 'рдЦрд░реЗрджреАрджрд╛рд░ рд╡рд┐рдирдВрддреНрдпрд╛', 'dash_buyer_req_p': 'рдорд╛рдЧрдгреА рдкрд╣рд╛',
                'dash_add_req_h': 'рд╡рд┐рдирдВрддреА рдиреЛрдВрджрд╡рд╛', 'dash_add_req_p': 'рдорд╛рд▓ рдЦрд░реЗрджреАрдЪреА рд╡рд┐рдирдВрддреА',
                'dash_market_h': 'рд╕реНрдерд╛рдирд┐рдХ рдмрд╛рдЬрд╛рд░рдкреЗрда', 'dash_market_p': 'рд╢реЗрддрдХрд░реА рдЙрддреНрдкрд╛рджрдиреЗ',
                'dash_my_listing': 'тЪб рдорд╛рдЭреА рд▓рд┐рд╕реНрдЯрд┐рдВрдЧ (My Products)',
                'dash_my_req': 'ЁЯУв рдорд╛рдЭреНрдпрд╛ рд╡рд┐рдирдВрддреНрдпрд╛ (My Requests)',
                'switch_farmer': 'рд╢реЗрддрдХрд░реА (Farmer)', 'switch_trader': 'рд╡реНрдпрд╛рдкрд╛рд░реА (Trader)', 'switch_reset': 'ЁЯЪл рдирд╡реАрди рдиреЛрдВрджрдгреА рдХрд░рд╛',
                'profile_title': 'рдорд╛рдЭрд╛ рдкреНрд░реЛрдлрд╛рдЗрд▓ (My Profile)',
                'label_name_p': 'рдирд╛рд╡:', 'label_phone_p': 'рдлреЛрди рдирдВрдмрд░:', 'label_taluka_p': 'рддрд╛рд▓реБрдХрд╛:', 'label_role_p': 'рднреВрдорд┐рдХрд╛:',
                'btn_back': 'рдорд╛рдЧреЗ рдЬрд╛',
                'buyer_req_title': 'рдЦрд░реЗрджреАрджрд╛рд░ рд╡рд┐рдирдВрддреНрдпрд╛ (Buyer Requests)', 'buyer_req_subtitle': 'рддреБрдордЪреНрдпрд╛ рдорд╛рд▓рд╛рдЪреА рдорд╛рдЧрдгреА рдХрд░рдгрд╛рд░реЗ рд╡реНрдпрд╛рдкрд╛рд░реАред',
                'market_title': 'ЁЯЫТ рд╕реНрдерд╛рдирд┐рдХ рд╢реЗрддрдХрд░реА рдмрд╛рдЬрд╛рд░рдкреЗрда', 'market_subtitle': 'рд╡рд┐рдХреНрд░реАрд╕рд╛рдареА рдЙрдкрд▓рдмреНрдз рдЕрд╕рд▓реЗрд▓реА рд╢реЗрддрдХрд░реА рдЙрддреНрдкрд╛рджрдиреЗред',
                'subsidy_portal_title': 'рд╕рд░рдХрд╛рд░реА рдпреЛрдЬрдирд╛ рдкреЛрд░реНрдЯрд▓', 'subsidy_portal_subtitle': 'рддреБрдордЪреНрдпрд╛ рднреВрдорд┐рдХреЗрдиреБрд╕рд╛рд░ рдЬреБрд│рдгрд╛рд▒реНрдпрд╛ рдкреНрд░рдореБрдЦ рдпреЛрдЬрдирд╛ред',
                'list_product_form_title': 'рдирд╡реАрди рдЙрддреНрдкрд╛рджрди рдЬреЛрдбрд╛', 'list_product_form_subtitle': 'рд╡рд┐рдХреНрд░реАрд╕рд╛рдареА рдЙрдкрд▓рдмреНрдз рдорд╛рд▓ рдЖрдгрд┐ рдХрд┐рдВрдордд рдорд╛рд╣рд┐рддреА рдкреНрд░рд╡рд┐рд╖реНрдЯ рдХрд░рд╛ред',
                'list_p_name_l': 'рдЙрддреНрдкрд╛рджрдирд╛рдЪреЗ рдирд╛рд╡:', 'list_p_qty_l': 'рдЙрдкрд▓рдмреНрдз рдорд╛рддреНрд░рд╛ (Kg/Quintal):', 'list_p_price_l': 'рд╡рд┐рдХреНрд░реА рджрд░ (тВ╣ рдкреНрд░рддрд┐ рдпреБрдирд┐рдЯ):',
                'btn_list_market': 'рдмрд╛рдЬрд╛рд░рдкреЗрдареЗрдд рд╕реВрдЪреАрдмрджреНрдз рдХрд░рд╛',
                'list_req_form_title': 'рдЦрд░реЗрджреА рд╡рд┐рдирдВрддреА рдиреЛрдВрджрд╡рд╛', 'list_req_form_subtitle': 'рддреБрдореНрд╣реА рдХрд╛рдп рд╢реЛрдзрдд рдЖрд╣рд╛рдд рдЖрдгрд┐ рддреБрдордЪреНрдпрд╛ рджреБрдХрд╛рдирд╛рдЪреА рдорд╛рд╣рд┐рддреА рджреНрдпрд╛ред',
                'list_s_name_l': 'рддреБрдордЪреНрдпрд╛ рджреБрдХрд╛рдирд╛рдЪреЗ/рд╕рдВрд╕реНрдереЗрдЪреЗ рдирд╛рд╡:', 'list_s_needs_l': 'рддреБрдореНрд╣рд╛рд▓рд╛ рдХреЛрдгрддреНрдпрд╛ рдорд╛рд▓рд╛рдЪреА рдЧрд░рдЬ рдЖрд╣реЗ?',
                'btn_publish_req': 'рд╡рд┐рдирдВрддреА рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд░рд╛',
                'prod_planner_title': 'рдЙрддреНрдкрд╛рджрди рдирд┐рдпреЛрдЬрдХ (Production Planner)', 'prod_planner_subtitle': 'рддреБрдордЪрд╛ рдЬрдорд┐рдиреАрдЪрд╛ рдкреНрд░рдХрд╛рд░ рдЖрдгрд┐ рдЕрдкреЗрдХреНрд╖рд┐рдд рдкрд╛рдКрд╕ рдирд┐рд╡рдбрд╛:',
                'label_soil': 'рдЬрдорд┐рдиреАрдЪрд╛ рдкреНрд░рдХрд╛рд░ (Soil Type):', 'label_rain': 'рдЕрдкреЗрдХреНрд╖рд┐рдд рдкрд╛рдКрд╕ (Expected Rainfall):',
                'btn_get_reco': 'рд╢рд┐рдлрд╛рд░рд╕ рдорд┐рд│рд╡рд╛ (Get Recommendation)', 'prod_initial_text': 'рд╡рд░рдЪреЗ рдмрдЯрдг рджрд╛рдмреВрди рд╢рд┐рдлрд╛рд░рд╕ рдорд┐рд│рд╡рд╛ред',
                'price_title': 'ЁЯУИ рд╡рд┐рдХреНрд░реА рдЖрдгрд┐ рджрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг', 'price_subtitle': 'рддреБрдордЪреНрдпрд╛ рдЙрддреНрдкрд╛рджрдирд╛рдЪрд╛ рдмрд╛рдЬрд╛рд░ рджрд░ рдЖрдгрд┐ рд╡рд┐рдХреНрд░реАрдЪреА рдорд╛рд╣рд┐рддреА рдкреНрд░рд╡рд┐рд╖реНрдЯ рдХрд░рд╛ред',
                'list_p_name_l_p': 'рдЙрддреНрдкрд╛рджрдирд╛рдЪреЗ рдирд╛рд╡ (Product Name):', 'list_p_qty_l_p': 'рдЙрдкрд▓рдмреНрдз рдорд╛рддреНрд░рд╛ (Quantity - Kg/L):', 'price_cost_l': 'рдЙрддреНрдкрд╛рджрди рдЦрд░реНрдЪ (Cost/Kg - тВ╣):',
                'price_your_price_l': 'рддреБрдордЪрд╛ рдЕрдкреЗрдХреНрд╖рд┐рдд рджрд░ (Your Price - тВ╣/Kg):', 'btn_analyze_price': 'рджрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рд╛ (Analyze Price & List)',
                'price_select_p': '-- рдЙрддреНрдкрд╛рджрди рдирд┐рд╡рдбрд╛ --', 'price_reco_h': 'рд╢рд┐рдлрд╛рд░рд╕ рдХреЗрд▓реЗрд▓рд╛ рджрд░ (Recommended Price Range)',
                'price_reco_init': '**рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рдмрдЯрдг рджрд╛рдмрд╛**', 'price_reco_p': 'рдмрд╛рдЬрд╛рд░рд╛рддреАрд▓ рдорд╛рдЧрдгреА рдЖрдгрд┐ рдЦрд░реНрдЪрд╛рд╡рд░ рдЖрдзрд╛рд░рд┐рддред',
                'price_current_p1': '**рдЙрддреНрдкрд╛рджрди:** --', 'price_current_p2': '**рд▓рд╛рдЗрд╡реНрд╣ APMC рджрд░:** --', 'price_current_p3': '**рдЖрдкрд▓рд╛ рдЙрддреНрдкрд╛рджрди рдЦрд░реНрдЪ:** --',
                'knn_profit': 'рдкреНрд░реЙрдлрд┐рдЯ рдЕрдиреБрдорд╛рди (Est. Profit):', 'knn_water': 'рдкрд╛рдгреНрдпрд╛рдЪреА рдЧрд░рдЬ (Water Need):', 'knn_match': 'рд╕рд░рдХрд╛рд░реА рдпреЛрдЬрдирд╛ рдЬреБрд│рд▓реА!',
                'market_unit': 'тВ╣ рдкреНрд░рддрд┐ рдпреБрдирд┐рдЯ', 'market_seller': 'рд╡рд┐рдХреНрд░реЗрддрд╛', 'market_qty': 'Kg', 'req_contact': 'ЁЯУЮ рд╕рдВрдкрд░реНрдХ',
                'req_needs': 'рдЧрд░рдЬ:', 'req_trader': 'рд╡реНрдпрд╛рдкрд╛рд░реА:', 'req_shop': 'рджреБрдХрд╛рди:',
                'dash_my_products': 'рдорд╛рдЭреЗ рд╕реВрдЪреАрдмрджреНрдз рдорд╛рд▓', 'dash_my_requests': 'рдорд╛рдЭреНрдпрд╛ рд╕реНрдерд╛рдирд┐рдХ рд╡рд┐рдирдВрддреНрдпрд╛',
                'default_taluka_name': 'рд╢рд┐рд░реВрд░',
                'home_welcome': 'ЁЯСЛ рдирдорд╕реНрддреЗ,',
                'home_welcome_role': 'рднреВрдорд┐рдХрд╛'
            },
            'en': {
                'app_title': 'Gram-Labh Navigator',
                'loading_title': 'Loading...',
                'loading_subtitle': 'Checking Local Data...',
                'welcome_title': 'ЁЯСЛ Welcome to Gram-Labh!',
                'register_subtitle': 'Please register to use the service.',
                'label_name': 'Full Name:', 'label_phone': 'Phone Number:', 'label_taluka': 'Taluka:',
                'btn_next': 'Next Step тЖТ',
                'role_select_title': 'Select Your Role', 'role_select_subtitle': 'What is your primary role?',
                'role_farmer_h': 'Farmer / Seller', 'role_farmer_p': 'Needs advice on production, pricing, and subsidies.',
                'role_trader_h': 'Trader / Buyer', 'role_trader_p': 'Needs market rates, demand, and logistics info.',
                'dash_planner_h': 'Planner', 'dash_planner_p': 'Production Advice',
                'dash_subsidy_h': 'Grants', 'dash_subsidy_p': 'Check Schemes',
                'dash_price_h': 'Price Analysis', 'dash_price_p': 'Set Sale Price', 'dash_price_t_p': 'Set Purchase Price',
                'dash_add_p_h': 'Add Product', 'dash_add_p_p': 'List for Sale',
                'dash_buyer_req_h': 'Buyer Requests', 'dash_buyer_req_p': 'View Demand',
                'dash_add_req_h': 'Post Request', 'dash_add_req_p': 'Request Goods',
                'dash_market_h': 'Local Market', 'dash_market_p': 'Farmer Products',
                'dash_my_listing': 'тЪб My Listings (Products)',
                'dash_my_req': 'ЁЯУв My Requests (Needs)',
                'switch_farmer': 'Farmer', 'switch_trader': 'Trader', 'switch_reset': 'ЁЯЪл New Registration',
                'profile_title': 'My Profile',
                'label_name_p': 'Name:', 'label_phone_p': 'Phone Number:', 'label_taluka_p': 'Taluka:', 'label_role_p': 'Role:',
                'btn_back': 'Go Back',
                'buyer_req_title': 'Buyer Requests', 'buyer_req_subtitle': 'Traders demanding your goods (Contact immediately).',
                'market_title': 'ЁЯЫТ Local Farmer Market', 'market_subtitle': 'Available goods listed by farmers.',
                'subsidy_portal_title': 'Government Schemes Portal', 'subsidy_portal_subtitle': 'Major schemes matched to your role.',
                'list_product_form_title': 'Add New Product', 'list_product_form_subtitle': 'Enter details and price for sale.',
                'list_p_name_l': 'Product Name:', 'list_p_qty_l': 'Quantity (Kg/Quintal):', 'list_p_price_l': 'Sale Price (тВ╣ per unit):',
                'btn_list_market': 'List on Marketplace',
                'list_req_form_title': 'Post Purchase Request', 'list_req_form_subtitle': 'What you are looking for and your shop details.',
                'list_s_name_l': 'Shop/Company Name:', 'list_s_needs_l': 'What goods do you need?',
                'btn_publish_req': 'Publish Request',
                'prod_planner_title': 'Production Planner', 'prod_planner_subtitle': 'Select your soil type and expected rainfall:',
                'label_soil': 'Soil Type:', 'label_rain': 'Expected Rainfall:',
                'btn_get_reco': 'Get Recommendation', 'prod_initial_text': 'Press the button above for recommendations.',
                'price_title': 'ЁЯУИ Sale & Price Analysis', 'price_subtitle': 'Enter your cost and price information for market analysis.',
                'list_p_name_l_p': 'Product Name:', 'list_p_qty_l_p': 'Quantity (Kg/L):', 'price_cost_l': 'Production Cost (Cost/Kg - тВ╣):',
                'price_your_price_l': 'Your Expected Price (Your Price - тВ╣/Kg):', 'btn_analyze_price': 'Analyze Price & List',
                'price_select_p': '-- Select Product --', 'price_reco_h': 'Recommended Price Range',
                'price_reco_init': '**Press button to analyze**', 'price_reco_p': 'Based on market demand and cost.',
                'price_current_p1': '**Product:** --', 'price_current_p2': '**Live APMC Rate:** --', 'price_current_p3': '**Your Production Cost:** --',
                'knn_profit': 'Est. Profit:', 'knn_water': 'Water Need:', 'knn_match': 'Govt Scheme Matched!',
                'market_unit': 'тВ╣ per Unit', 'market_seller': 'Seller:', 'market_qty': 'Kg', 'req_contact': 'ЁЯУЮ Contact',
                'req_needs': 'Needs:', 'req_trader': 'Trader:', 'req_shop': 'Shop:',
                'dash_my_products': 'My Listed Products', 'dash_my_requests': 'My Local Requests',
                'default_taluka_name': 'Shirur',
                'home_welcome': 'ЁЯСЛ Hello,',
                'home_welcome_role': 'Role'
            }
        };

        function getText(key) {
            // Returns the localized text or the key if translation is missing
            return LANGUAGES[currentLang][key] || key;
        }

        function switchLanguage() {
            // Toggle language code
            currentLang = currentLang === 'mr' ? 'en' : 'mr';
            localStorage.setItem('appLang', currentLang);
            // Re-render everything
            applyLanguage();
            // Go back to current screen to force rendering of dynamic content
            showScreen(document.querySelector('.screen.active').id);
        }

        function applyLanguage() {
            // Update static elements based on data-key attribute
            document.querySelectorAll('[data-key]').forEach(el => {
                el.innerHTML = getText(el.getAttribute('data-key'));
            });
            
            // Update the language toggle button text
            document.getElementById('lang-button').innerText = currentLang === 'mr' ? 'EN' : 'рдорд░рд╛рдареА';
        }

        // =================================================================
        // 2. DATASETS & RULES (Simulating Database)
        // =================================================================

        const NEIGHBORS = [
            { id: 1, soil: 'Black', rainfall: 'Medium', crop: 'Sugarcane', profit: 25, water: 'рдЬрд╛рд╕реНрдд', subsidy_key: 'HIGH_GRANT' },
            { id: 2, soil: 'Black', rainfall: 'Low', crop: 'Cotton', profit: 20, water: 'рдХрдореА', subsidy_key: 'LOW_RISK' },
            { id: 3, soil: 'Black', rainfall: 'Medium', crop: 'Onion', profit: 18, water: 'рдордзреНрдпрдо', subsidy_key: 'MAHADB_LINKED' },
            { id: 4, soil: 'Red', rainfall: 'High', crop: 'Mangoes (Horticulture)', profit: 30, water: 'рдордзреНрдпрдо', subsidy_key: 'HORTICULTURE_SCHEME' },
            { id: 5, soil: 'Red', rainfall: 'Medium', crop: 'Groundnut', profit: 17, water: 'рдХрдореА', subsidy_key: 'LOW_RISK' },
            { id: 6, soil: 'Red', rainfall: 'High', crop: 'Turmeric', profit: 22, water: 'рдЬрд╛рд╕реНрдд', subsidy_key: 'HIGH_GRANT' },
            { id: 7, soil: 'Alluvial', rainfall: 'High', crop: 'Paddy (Rice)', profit: 15, water: 'рдЬрд╛рд╕реНрдд', subsidy_key: 'LOW_RISK' },
            { id: 10, soil: 'Alluvial', rainfall: 'Low', crop: 'Brinjal', profit: 16, water: 'рдХрдореА', subsidy_key: 'NONE' },
        ];
        const SUBSIDY_SCHEMES = { 
            'HIGH_GRANT': { scheme_name: 'рдореБрдЦреНрдпрдордВрддреНрд░реА рдХреГрд╖реА рдЕрдиреБрджрд╛рди', benefit: '30% рднрд╛рдВрдбрд╡рд▓реА рдЕрдиреБрджрд╛рди', color: '#28a745', link: 'https://krishi.maharashtra.gov.in/en/schemes' },
            'MAHADB_LINKED': { scheme_name: 'рдорд╣рд╛рдирд┐рд░реНрдорд┐рддреА рд╢реЗрддрдХрд░реА рдкреЛрд░реНрдЯрд▓', benefit: 'рд╕рд░рдХрд╛рд░реА рдЦрд░реЗрджреА рд╣рдореА', color: '#17a2b8', link: 'https://mahadbtmahait.gov.in/Home/Index' },
            'HORTICULTURE_SCHEME': { scheme_name: 'рдлрд│рдмрд╛рдЧрд╛ рд╡рд┐рдХрд╛рд╕ рдпреЛрдЬрдирд╛', benefit: 'релреж% рдард┐рдмрдХ рд╕рд┐рдВрдЪрди рдЕрдиреБрджрд╛рди', color: '#28a745', link: 'https://horticulture.maharashtra.gov.in/' },
            'LOW_RISK': { scheme_name: 'рдкреАрдХ рд╡рд┐рдорд╛ рдпреЛрдЬрдирд╛', benefit: 'рд╢реВрдиреНрдп рддреЗ рдХрдореА рдкреНрд░реАрдорд┐рдпрдо', color: '#ffc107', link: 'https://pmfby.gov.in/' },
            'NONE': { scheme_name: 'рд╕рдзреНрдпрд╛ рдХреЛрдгрддреАрд╣реА рдпреЛрдЬрдирд╛ рдирд╛рд╣реА', benefit: 'рд╕реНрдерд╛рдирд┐рдХ рдЕрдзрд┐рдХрд╛рд░реА/рдЧреНрд░рд╛рдорд╕реЗрд╡рдХ рддрдкрд╛рд╕рд╛', color: '#dc3545', link: '#' }
        };
        const APMC_LIVE_RATES = {
            'Tomato': 25.50, 'Onion': 18.00, 'Turmeric': 90.00, 'Sugarcane': 35.00, 'Default': 30.00
        };
        const PROFIT_RULES = {
            COST_MARKUP_PERCENT: 0.15, MIN_PROFIT_MARGIN: 0.20, RANGE_SPREAD: 0.05
        };
        const STATIC_ACCOUNTS = {
            'farmer': { userName: 'рд░рдорд╛ рдкрд╛рдЯреАрд▓', userRole: 'Farmer/Seller', userPhone: '9876543210', userTaluka: 'рд╢рд┐рд░реВрд░' },
            'trader': { userName: 'рдореЛрд╣рди рдЯреНрд░реЗрдбрд░реНрд╕', userRole: 'Trader', userPhone: '9988776655', userTaluka: 'рджреМрдВрдб' }
        };
        const TRADER_DUMMY_REQUESTS = [
            { shopName: 'рд╕рд╛рдИ рдХреЛрд▓реНрдб рд╕реНрдЯреЛрд░реЗрдЬ', needs: '5000 рдХрд┐рд▓реЛ рд╣рд│рдж (Urgent)', trader: 'рдирд┐рдЦрд┐рд▓', phone: '9000111222', taluka: 'рдмрд╛рд░рд╛рдорддреА', date: '04/10/2025' },
            { shopName: 'рдЧрдгреЗрд╢ рдХрд┐рд░рд╛рдгрд╛', needs: '100 рдХрд┐рд▓реЛ рдЯреЛрдореЕрдЯреЛ', trader: 'рд╕реБрд░реЗрд╢', phone: '9000333444', taluka: 'рд╢рд┐рд░реВрд░', date: '05/10/2025' },
        ];
        const FARMER_DUMMY_PRODUCTS = [
            { product: 'рджреЗрд╢реА рдХрд╛рдВрджрд╛', quantity: 200, price: 21.00, seller: 'рдмрд╛рд│рд╛рд╕рд╛рд╣реЗрдм', phone: '9111222333', taluka: 'рдЬреБрдиреНрдирд░', date: '04/10/2025' },
            { product: 'рдКрд╕ (Sugarcane)', quantity: 15, price: 34.00, seller: 'рд╕рдВрджреАрдк', phone: '9555666777', taluka: 'рджреМрдВрдб', date: '05/10/2025' },
        ];

        // =================================================================
        // 3. CORE UTILITY FUNCTIONS (Needed for hoisting and immediate calls)
        // =================================================================
        
        function getProfileData() {
            return {
                userName: localStorage.getItem('userName'),
                userRole: localStorage.getItem('userRole'),
                userPhone: localStorage.getItem('userPhone'),
                userTaluka: localStorage.getItem('userTaluka')
            };
        }

        function getListings(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function saveListings(key, listings) {
            localStorage.setItem(key, JSON.stringify(listings));
        }

        function goBack() {
            const userRole = localStorage.getItem('userRole');
            if (userRole === 'Farmer/Seller') { showScreen('farmer-dashboard'); } 
            else if (userRole === 'Trader') { showScreen('trader-dashboard'); } 
            else { showScreen('onboarding'); }
        }

        function updateDashboardHeaders(name, role) {
            const taluka = localStorage.getItem('userTaluka') || getText('default_taluka_name');
            const welcomeId = role === 'Farmer/Seller' ? 'farmer-welcome' : 'trader-welcome';
            const infoId = role === 'Farmer/Seller' ? 'farmer-info-display' : 'trader-info-display';
            
            if(document.getElementById(welcomeId)) { 
                document.getElementById(welcomeId).innerHTML = `${getText('home_welcome')} ${name}!`;
                document.getElementById(infoId).innerHTML = `${getText('home_welcome_role')}: ${role} | ${getText('label_taluka_p')}: ${taluka}`;
            }
        }

        function initializeDummyData() {
            if (!localStorage.getItem('dummySeeded')) {
                saveListings('farmProducts', FARMER_DUMMY_PRODUCTS);
                saveListings('traderShops', TRADER_DUMMY_REQUESTS);
                localStorage.setItem('dummySeeded', 'true');
            }
        }

        function checkUserStatus() {
            const { userName, userRole } = getProfileData();
            if (userRole) {
                updateDashboardHeaders(userName, userRole);
                showScreen(userRole === 'Farmer/Seller' ? 'farmer-dashboard' : 'trader-dashboard');
            } else if (userName) {
                showScreen('role-select');
            } else {
                showScreen('onboarding');
            }
        }
        
        // =================================================================
        // 4. NAVIGATION AND STATE LOGIC
        // =================================================================
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            document.getElementById('quick-switch-modal').style.display = 'none';

            // DYNAMIC TITLE UPDATE
            const titleElement = document.getElementById(screenId).querySelector('h2[data-key]');
            const headerTitle = titleElement ? getText(titleElement.getAttribute('data-key')) : getText('app_title');
            document.getElementById('header-title').innerText = headerTitle;
            
            const hideHeader = (screenId === 'onboarding' || screenId === 'role-select');
            document.getElementById('app-header').style.display = hideHeader ? 'none' : 'flex';
            const backBtn = document.querySelector('.back-btn');
            if (backBtn) {
                backBtn.style.display = (screenId === 'loading' || hideHeader) ? 'none' : 'block';
            }

            // Render logic based on the destination screen
            if (screenId === 'farmer-dashboard') {
                renderFarmDashboard();
            } else if (screenId === 'trader-dashboard') {
                renderTraderDashboard();
            } else if (screenId === 'competition') {
                renderFarmerMarket(); 
            } else if (screenId === 'trader-requests-for-farmer') {
                renderTraderRequestsForFarmer();
            } else if (screenId === 'user-profile') { 
                fillProfileForm(); 
            } else if (screenId === 'subsidy-info-page') { 
                renderSubsidyInfo();
            }
            // Ensure static content updates its language after screen switch
            applyLanguage();
        }

        // --- AUTH/ONBOARDING FUNCTIONS ---

        function selectRole(role) {
            localStorage.setItem('userRole', role);
            const userName = localStorage.getItem('userName');
            
            updateDashboardHeaders(userName, role);
            showScreen(role === 'Farmer/Seller' ? 'farmer-dashboard' : 'trader-dashboard');
        }


        // --- PROFILE FUNCTIONS ---

        function showProfile() { 
            fillProfileForm(); 
            showScreen('user-profile'); 
        }

        function fillProfileForm() {
            document.getElementById('profile-name').value = localStorage.getItem('userName') || '';
            document.getElementById('profile-phone').value = localStorage.getItem('userPhone') || '';
            document.getElementById('profile-taluka').value = localStorage.getItem('userTaluka') || '';
            document.getElementById('profile-role').value = localStorage.getItem('userRole') || '';
        }

        // --- ACCOUNT SWITCHING ---

        function toggleQuickSwitchModal() {
            const modal = document.getElementById('quick-switch-modal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }

        function quickSwitchAccount(roleKey) {
            const accountData = STATIC_ACCOUNTS[roleKey];
            localStorage.clear();
            localStorage.setItem('userName', accountData.userName);
            localStorage.setItem('userRole', accountData.userRole);
            localStorage.setItem('userPhone', accountData.userPhone);
            localStorage.setItem('userTaluka', accountData.userTaluka);
            
            // Reloads the app state for the new user
            checkUserStatus(); 
        }

        // =================================================================
        // 5. FEATURE LOGIC (Updated to use getText())
        // =================================================================

        // --- KNN Production Planner ---
        function runKNN() {
            const userSoil = document.getElementById('soil-type').value;
            const userRainfall = document.getElementById('rainfall').value;
            const recommendationsDiv = document.getElementById('production-recommendations');
            
            // KNN Simulation Logic (unchanged)
            const soilMap = { 'Black': 3, 'Red': 2, 'Alluvial': 1 };
            const rainfallMap = { 'High': 3, 'Medium': 2, 'Low': 1 };
            const userFeature = [soilMap[userSoil], rainfallMap[userRainfall]];

            const neighborsWithDistance = NEIGHBORS.map(neighbor => {
                let distance = 0;
                if (soilMap[neighbor.soil] !== userFeature[0]) distance += 1;
                if (rainfallMap[neighbor.rainfall] !== userFeature[1]) distance += 1;
                distance -= (neighbor.profit / 100); 
                return { ...neighbor, distance: distance };
            });

            const K = 3;
            neighborsWithDistance.sort((a, b) => {
                if (a.distance !== b.distance) { return a.distance - b.distance; }
                return b.profit - a.profit; 
            });
            const topRecommendations = neighborsWithDistance.slice(0, K);
            let htmlContent = '';
            
            topRecommendations.forEach((reco, index) => {
                const rankText = index === 0 ? 'ЁЯеЗ' : (index === 1 ? 'ЁЯеИ' : 'ЁЯеЙ');
                const bestClass = index === 0 ? 'best' : '';
                const subsidyInfo = SUBSIDY_SCHEMES[reco.subsidy_key];
                
                htmlContent += `
                    <div class="reco-item ${bestClass}">
                        <span class="reco-icon">${rankText}</span>
                        <h4>${reco.crop}</h4>
                        <p>ЁЯФе **${getText('knn_profit')}:** ${reco.profit}%</p>
                        <p>ЁЯТз **${getText('knn_water')}:** ${reco.water}</p>
                        <div class="subsidy-box" style="border-left-color: ${subsidyInfo.color};">
                            **${getText('knn_match')}!**
                            <span class="scheme-name">Scheme: ${subsidyInfo.scheme_name}</span>
                            <span class="scheme-name">Benefit: ${subsidyInfo.benefit}</span>
                        </div>
                    </div>
                `;
            });
            recommendationsDiv.innerHTML = htmlContent;
        }

        // --- Pricing Advisor ---
        function runPricingAdvisor() {
            const productName = document.getElementById('product-select').value;
            const costInput = parseFloat(document.getElementById('cost').value);
            const quantityInput = parseFloat(document.getElementById('quantity').value);
            const userPriceInput = parseFloat(document.getElementById('user-price-input').value);
            
            if (!productName || isNaN(costInput) || isNaN(quantityInput) || isNaN(userPriceInput)) {
                alert(currentLang === 'mr' ? "рдХреГрдкрдпрд╛ рдЙрддреНрдкрд╛рджрди рдирд┐рд╡рдбрд╛ рдЖрдгрд┐ рд╕рд░реНрд╡ рд╕рдВрдЦреНрдпрд╛рддреНрдордХ рдорд╛рд╣рд┐рддреА рднрд░рд╛ред" : "Please select a product and fill in all numerical information."); 
                return;
            }

            const liveApmcRate = APMC_LIVE_RATES[productName] || APMC_LIVE_RATES['Default'];
            const basePrice = liveApmcRate;
            const costPlusMarkup = costInput * (1 + PROFIT_RULES.COST_MARKUP_PERCENT);
            const priceWithMinProfit = costInput / (1 - PROFIT_RULES.MIN_PROFIT_MARGIN);
            const optimalPrice = Math.ceil(Math.max(basePrice, costPlusMarkup, priceWithMinProfit));

            const spreadAmount = optimalPrice * PROFIT_RULES.RANGE_SPREAD;
            const lowerBound = Math.floor(optimalPrice - spreadAmount);
            const upperBound = Math.ceil(optimalPrice + spreadAmount);

            let comparisonAlertHTML = '';
            let comparisonClass = '';
            
            // Logic for comparison alerts (updated to use getText)
            if (userPriceInput < lowerBound * 0.95) { 
                comparisonClass = 'alert-low';
                comparisonAlertHTML = currentLang === 'mr' ? `**тЭМ рд╕рд╛рд╡рдз рд░рд╣рд╛!** рддреБрдордЪрд╛ рджрд░ рдмрд╛рдЬрд╛рд░рд╛рдкреЗрдХреНрд╖рд╛ **рдЦреВрдк рдХрдореА** рдЖрд╣реЗред рддреБрдореНрд╣рд╛рд▓рд╛ тВ╣${lowerBound.toFixed(2)} рдкрд░реНрдпрдВрдд рдирдлрд╛ рдорд┐рд│реВ рд╢рдХрддреЛред` : `**тЭМ Warning!** Your price is **too low**. You could potentially earn up to тВ╣${lowerBound.toFixed(2)}.`;
            } else if (userPriceInput > upperBound * 1.1) { 
                comparisonClass = 'alert-high';
                comparisonAlertHTML = currentLang === 'mr' ? `**тЪая╕П рдЬрд╛рд╕реНрдд рджрд░!** рддреБрдордЪрд╛ рджрд░ рдмрд╛рдЬрд╛рд░рд╛рдд рдЯрд┐рдХрдгрд╛рд░ рдирд╛рд╣реАред рд╢рд┐рдлрд╛рд░рд╕ рдХреЗрд▓реЗрд▓реЗ рджрд░ рд╡рд╛рдкрд░рд╛ред` : `**тЪая╕П Too High!** Your price won't be competitive. Use the recommended range.`;
            } else { 
                comparisonClass = 'alert-ok';
                comparisonAlertHTML = currentLang === 'mr' ? `**тЬЕ рджрд░ рдпреЛрдЧреНрдп!** рддреБрдордЪрд╛ рджрд░ рд╢рд┐рдлрд╛рд░рд╕ рдХреЗрд▓реЗрд▓реНрдпрд╛ рд╢реНрд░реЗрдгреАрдд рдЖрд╣реЗред` : `**тЬЕ Price is Good!** Your price is within the recommended range.`;
            }

            document.querySelector('#pricing .price-range').innerHTML = 
                `**тВ╣ ${lowerBound.toFixed(2)} - тВ╣ ${upperBound.toFixed(2)} / ${currentLang === 'mr' ? 'рдХрд┐рд▓реЛ' : 'Kg'}**`;
            
            document.getElementById('price-comparison-alert').className = `comparison-alert ${comparisonClass}`;
            document.getElementById('price-comparison-alert').innerHTML = comparisonAlertHTML;
            
            document.querySelector('#pricing .current-market-data').innerHTML = 
                `${getText('price_current_p1')}: ${productName} (${quantityInput} ${getText('market_qty')}) <br>` +
                `${getText('price_current_p2')}: тВ╣ ${liveApmcRate.toFixed(2)} / ${currentLang === 'mr' ? 'рдХрд┐рд▓реЛ' : 'Kg'} <br>` +
                `${getText('price_current_p3')}: тВ╣ ${costInput.toFixed(2)} / ${currentLang === 'mr' ? 'рдХрд┐рд▓реЛ' : 'Kg'}`;

            document.getElementById('price-result-message').style.display = 'block';
        }

        // --- Marketplace Rendering Functions (Local Storage) ---

        function renderFarmDashboard() { 
            const myName = localStorage.getItem('userName');
            const allProducts = getListings('farmProducts');
            const myProducts = allProducts.filter(p => p.seller === myName);
            const container = document.getElementById('my-farm-listings');
            const emptyText = currentLang === 'mr' ? 'рд╕рдзреНрдпрд╛ рдХреЛрдгрддрд╛рд╣реА рдорд╛рд▓ рд╕реВрдЪреАрдмрджреНрдз рдирд╛рд╣реАред' : 'No products currently listed.';

            if (myProducts.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-600">${emptyText}</p>`;
                return;
            }

            container.innerHTML = myProducts.map(p => `
                <div class="reco-item comp-item p-3 shadow-sm border-l-4 border-green-500">
                    <h4 class="font-bold">${p.product} (${p.quantity} ${getText('market_qty')})</h4>
                    <p class="text-sm text-gray-700">ЁЯТ░ ${getText('price_your_price_l')}: тВ╣ ${p.price} / ${getText('market_unit')}</p>
                    <p class="text-xs text-gray-500">ЁЯУН ${currentLang === 'mr' ? 'рд▓рд┐рд╕реНрдЯрд┐рдВрдЧ рддрд╛рд░реАрдЦ' : 'Listing Date'}: ${p.date}</p>
                </div>
            `).join('');
        }

        function renderTraderDashboard() {
            const myName = localStorage.getItem('userName');
            const allRequests = getListings('traderShops');
            const myRequests = allRequests.filter(r => r.trader === myName);
            const container = document.getElementById('my-trader-requests');
            const emptyText = currentLang === 'mr' ? 'рд╕рдзреНрдпрд╛ рдХреЛрдгрддреАрд╣реА рдЦрд░реЗрджреА рд╡рд┐рдирдВрддреА рдиреЛрдВрджрд╡рд▓реЗрд▓реА рдирд╛рд╣реАред' : 'No purchase requests currently recorded.';

            if (myRequests.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-600">${emptyText}</p>`;
                return;
            }

            container.innerHTML = myRequests.map(r => `
                <div class="reco-item comp-item p-3 shadow-sm border-l-4 border-blue-500">
                    <h4 class="font-bold">${r.shopName}</h4>
                    <p class="text-sm text-gray-700">ЁЯФН ${getText('req_needs')}: ${r.needs}</p>
                    <p class="text-xs text-gray-500">ЁЯУН ${currentLang === 'mr' ? 'рддрд╛рд░реАрдЦ' : 'Date'}: ${r.date}</p>
                </div>
            `).join('');
        }

        function renderTraderRequestsForFarmer() {
            const allRequests = getListings('traderShops'); 
            const container = document.getElementById('trader-request-listings');
            const emptyText = currentLang === 'mr' ? 'рд╕рдзреНрдпрд╛ рдХреЛрдгрддреАрд╣реА рд╡реНрдпрд╛рдкрд╛рд░реА рд╡рд┐рдирдВрддреА рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реАред' : 'No trader requests available.';

            if (allRequests.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-600">${emptyText}</p>`;
                return;
            }

            container.innerHTML = allRequests.map(r => `
                <div class="reco-item best-price p-3 shadow-md bg-blue-50">
                    <h4 class="text-lg font-bold text-blue-800">${r.shopName}</h4>
                    <p class="text-sm text-gray-700 mb-2">ЁЯФН ${getText('req_needs')}: **${r.needs}**</p>
                    <p class="text-xs text-gray-600">ЁЯЪЪ ${getText('req_trader')}: ${r.trader} (${r.taluka})</p>
                    <div class="subsidy-box mt-2 border-l-4 border-blue-800 bg-white">
                        **${getText('req_contact')}:** <a href="tel:${r.phone}" class="text-blue-600 font-bold">${r.phone}</a>
                    </div>
                </div>
            `).join('');
        }

        function renderFarmerMarket() {
            const allProducts = getListings('farmProducts'); 
            const container = document.getElementById('farmer-market-listings');
            const emptyText = currentLang === 'mr' ? 'рд╕рдзреНрдпрд╛ рд╡рд┐рдХреНрд░реАрд╕рд╛рдареА рдХреЛрдгрддрд╛рд╣реА рдорд╛рд▓ рд╕реВрдЪреАрдмрджреНрдз рдирд╛рд╣реАред' : 'No goods currently listed for sale.';

            if (allProducts.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-600">${emptyText}</p>`;
                return;
            }

            container.innerHTML = allProducts.map(p => `
                <div class="reco-item best p-3 shadow-md bg-green-50">
                    <span class="reco-icon">ЁЯЫТ</span>
                    <h4 class="text-lg font-bold text-green-800">${p.product} | ${p.quantity} ${getText('market_qty')}</h4>
                    <p class="text-sm text-gray-700 mb-2">ЁЯТ░ ${currentLang === 'mr' ? 'рдорд╛рдЧрд┐рддрд▓реЗрд▓рд╛ рджрд░' : 'Asking Price'}: **тВ╣ ${p.price} / ${getText('market_unit')}**</p>
                    <p class="text-xs text-gray-600">ЁЯзСтАНЁЯМ╛ ${getText('market_seller')}: ${p.seller} (${p.taluka})</p>
                    <div class="subsidy-box mt-2 border-l-4 border-green-800 bg-white">
                        **${getText('req_contact')}:** <a href="tel:${p.phone}" class="text-green-600 font-bold">${p.phone}</a>
                    </div>
                </div>
            `).join('');
        }

        function renderSubsidyInfo() {
            const container = document.getElementById('general-subsidy-list');
            let htmlContent = '';

            for (const key in SUBSIDY_SCHEMES) {
                const scheme = SUBSIDY_SCHEMES[key];
                if (key === 'NONE') continue; 

                const statusText = scheme.color === '#28a745' ? (currentLang === 'mr' ? 'рд╕рдХреНрд░рд┐рдп рдЖрдгрд┐ рдЙрдЪреНрдЪ рд▓рд╛рдн' : 'Active & High Benefit') : (currentLang === 'mr' ? 'рд╕рдХреНрд░рд┐рдп' : 'Active');
                
                htmlContent += `
                    <div class="reco-item" style="border-left: 5px solid ${scheme.color};">
                        <h4>${scheme.scheme_name}</h4>
                        <p>ЁЯОБ **${currentLang === 'mr' ? 'рд▓рд╛рдн' : 'Benefit'}:** ${scheme.benefit}</p>
                        <p>тЬЕ **${currentLang === 'mr' ? 'рд╕реНрдерд┐рддреА' : 'Status'}:** ${statusText}</p>
                        <a href="${scheme.link}" target="_blank" class="action-btn view-detail-btn">${currentLang === 'mr' ? 'рддрдкрд╢реАрд▓ рдкрд╣рд╛' : 'View Details'}</a>
                    </div>
                `;
            }
            container.innerHTML = htmlContent || `<p class="text-center text-gray-600">${currentLang === 'mr' ? 'рд╕рдзреНрдпрд╛ рдХреЛрдгрддреАрд╣реА рдпреЛрдЬрдирд╛ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реАред' : 'No schemes available at this time.'}</p>`;
        }


        // =================================================================
        // 6. APP INITIALIZATION & EVENT LISTENERS
        // =================================================================

        function attachEventListeners() {
            // 1. Registration Form
            document.getElementById('reg-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('reg-name').value;
                const phone = document.getElementById('reg-phone').value;
                const taluka = document.getElementById('reg-taluka').value;
                
                localStorage.setItem('userName', name);
                localStorage.setItem('userPhone', phone);
                localStorage.setItem('userTaluka', taluka);
                showScreen('role-select');
            });

            // 2. Profile Edit Form 
            document.getElementById('profile-edit-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Save changes
                localStorage.setItem('userName', document.getElementById('profile-name').value);
                localStorage.setItem('userPhone', document.getElementById('profile-phone').value);
                localStorage.setItem('userTaluka', document.getElementById('profile-taluka').value);
                
                alert(currentLang === 'mr' ? "рдкреНрд░реЛрдлрд╛рдЗрд▓ рддрдкрд╢реАрд▓ рдпрд╢рд╕реНрд╡реАрд░рд┐рддреНрдпрд╛ рдЬрддрди рдХреЗрд▓рд╛! (Simulation)" : "Profile details successfully saved! (Simulation)");
                goBack();
            });

            // 3. Farmer Listing Form
            document.getElementById('product-listing-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const product = document.getElementById('list-product').value;
                const qty = document.getElementById('list-qty').value;
                const price = document.getElementById('list-price').value;
                
                const newProduct = {
                    product: product, quantity: parseFloat(qty), price: parseFloat(price),
                    seller: localStorage.getItem('userName'), phone: localStorage.getItem('userPhone'),
                    taluka: localStorage.getItem('userTaluka'), date: new Date().toLocaleDateString('en-IN')
                };
                const currentListings = getListings('farmProducts');
                currentListings.unshift(newProduct);
                saveListings('farmProducts', currentListings);
                
                document.getElementById('product-listing-form').reset();
                alert(currentLang === 'mr' ? `рдЙрддреНрдкрд╛рджрди ${product} рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕реВрдЪреАрдмрджреНрдз рдЭрд╛рд▓реЗ!` : `Product ${product} successfully listed!`);
                showScreen('farmer-dashboard');
            });

            // 4. Trader Listing Form
            document.getElementById('shop-listing-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const shopName = document.getElementById('list-shop-name').value;
                const needs = document.getElementById('list-needs').value;
                
                const newRequest = {
                    shopName: shopName, needs: needs,
                    trader: localStorage.getItem('userName'), phone: localStorage.getItem('userPhone'),
                    taluka: localStorage.getItem('userTaluka'), date: new Date().toLocaleDateString('en-IN')
                };

                const currentRequests = getListings('traderShops');
                currentRequests.unshift(newRequest);
                saveListings('traderShops', currentRequests);
                
                document.getElementById('shop-listing-form').reset();
                alert(currentLang === 'mr' ? `рдЦрд░реЗрджреА рд╡рд┐рдирдВрддреА ${shopName} рд╕рд╛рдареА рдиреЛрдВрджрд╡рд▓реА рдЧреЗрд▓реА!` : `Purchase request for ${shopName} has been recorded!`);
                showScreen('trader-dashboard');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            currentLang = localStorage.getItem('appLang') || 'mr';
            applyLanguage();
            initializeDummyData();
            attachEventListeners();
            checkUserStatus(); 
        });
    </script>
</body>
</html>
